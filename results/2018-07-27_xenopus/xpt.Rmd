---
title: "Xenopus Tropicalis analysis"
author: "Kent Riemondy RBI"
date: '`r Sys.Date()`'
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

## Xenopus Tropicalis MZT analysis

## RNA-Seq Libraries
```{r load_libs}
source("../../R/globals.r")
```



```{r get_metadata}
mdata <- read_tsv(file.path(data_dir, "raw_data", "xenopus_t", 
                            "OWENS", "PRJNA275011.txt"))

count_data_dir <- file.path(data_dir, 
                            "featurecounts",
                            "xenopus_t",
                            "OWENS")

count_files <- dir(count_data_dir,
                   pattern = "_counts.tsv$",
                   recursive = T,
                   full.names = T)

sample_names <- str_split(count_files, "\\/") %>% 
  map_chr(., ~.x[10]) %>% 
  str_replace(., "_counts.tsv", "") 

sample_names_simple <- str_replace(sample_names, "_exon|_intron", "")
 
mdata <- mdata %>% 
  filter(run_accession %in% str_replace(sample_names, "_exon|_intron", ""))

mdata <- separate(mdata,
                sample_title,
                c("clutch",
                  "lib_type",
                  "timepoint",
                  "timetype"),
                sep = "_",
                remove = F)
mdata
```

## Load in featurecounts data

```{r load_dat, message = F}

dat <- map(count_files, read_tsv, skip = 2, 
           col_types = "c----ci", 
           col_names = c("gene_id", "length", "counts"))

# name with libraryID
names(dat) <- sample_names

dat <- bind_rows(dat, .id = "sample_name")
dat <- mutate(dat, 
              run_accession = str_replace(sample_name, 
                                             "_exon|_intron", 
                                             ""),
              count_type = ifelse(str_detect(sample_name, "exon"),
                                  "exon",
                                  "intron"))
#join with main data
dat <- inner_join(dat, 
                  mdata,
                  by = c("run_accession"))

```

### transcript to gene mapping
```{r drop_monoexonic}
gtf <- "~/Projects/shared_dbases/annotation/xenopus/jgi_xentrop9.1/xenTro9.gtf"
gtf <- import(gtf)
gtf <- as.data.frame(gtf)

gtf_summary <- dplyr::filter(gtf, type == "exon") %>% 
  dplyr::select(seqnames, start, end, strand, gene_id) %>% 
  dplyr::rename(chrom = seqnames) %>% 
  unique() %>% 
  group_by(gene_id) %>% 
  bed_merge() %>% 
  dplyr::summarize(total_exons = n())

monoexonic_genes <- dplyr::filter(gtf_summary, total_exons == 1) %>%
  pull(gene_id)
```


```{r remove_monoexonic}

dat <- anti_join(dat, 
                 data_frame(gene_id = monoexonic_genes),
                 by = "gene_id")

dat <- mutate(dat,
              monoexonic = gene_id %in% monoexonic_genes)

dat <- group_by(dat, sample_title) %>% 
  mutate(lib_size = sum(counts),
         eff_length = as.numeric(length) - 150 + 1) %>% 
  filter(eff_length > 0 ) %>% 
  mutate(rate = log(counts) - log(eff_length),
         total_rates = log(sum(exp(rate))),
         tpm = exp(rate - total_rates + log(1e6)))

```

### plot pre_mRNA ratio

```{r, calc_premRNA}
# sum primary and mature TPMs for each gene 
summary_dat <- dplyr::select(dat, tpm, gene_id, 
              sample_title, count_type, lib_type, timepoint) %>% 
  group_by(gene_id, sample_title, count_type) %>% 
  dplyr::summarize(total_tpm = sum(tpm, na.rm = F),
                   lib_type = unique(lib_type),
                   timepoint = as.numeric(unique(timepoint))) %>% 
  ungroup() 

## calc primary ratio
tpm_summary <- summary_dat %>% 
  spread(count_type, total_tpm) %>% 
  mutate(primary_ratio  = intron / (intron + exon))

## calc mean primary ratio
tpm_means <- tpm_summary %>% 
  group_by(gene_id, 
           timepoint,
           lib_type) %>% 
  summarize(mean_primary = mean(primary_ratio,
                                na.rm = T)) 
```

```{r premRNA_ratios}
tpm_means <- dplyr::ungroup(tpm_means)

plt <- ggplot(tpm_means, 
       aes(as.factor(timepoint), mean_primary)) +
  geom_boxplot(coef = 1e3) +
  facet_wrap(~lib_type) +
  labs(x = "",
       y = expression(frac("pre-mRNA TPM", 
                           "mature + pre-mRNA TPM"))) +
  theme(
    axis.text.x = element_text(angle = 90,
                               vjust = 0.5,
                               hjust = 0.5)
  )
plt
save_plot("pre_mRNA_ratios.pdf", 
          plt,
          base_aspect_ratio = 2)


plt <- ggplot(dat, 
       aes(as.factor(timepoint), tpm)) +
  geom_boxplot(coef = 1e3) +
  scale_y_log10() + 
  facet_wrap(lib_type~count_type, scales = "free_y") +
  labs(x = "",
       y = "TPM") +
  theme(
    axis.text.x = element_text(angle = 90,
                               vjust = 0.5,
                               hjust = 0.5)
  )
plt
save_plot("tpms_exon_intron.pdf", plt)
```

There is a very clear increase starting at ~4-4.5hpf. Interestingly you can see a slight increase in the poly(A)+ dataset, which is likely due to cytoplasmic polyadenylation.


## Classify transcripts into maternal or zygotic

Next I'll try to classify transcripts into catagories based upon their abundance changes throughout embryogenesis. 

```{r}
count_dat <- map2(count_files, 
                  sample_names,
                  ~read_tsv(
                    .x, 
                    skip = 2, 
                    col_types = "c-----i", 
                    col_names = c("gene_id", .y)))

count_mat <- Reduce(function(x, y) {
  inner_join(x, y, by = "gene_id")}, 
  count_dat)

exon_mat <- dplyr::select(count_mat, 
                          gene_id, 
                          contains("_exon")) %>% 
  as.data.frame() %>% 
  tibble::column_to_rownames("gene_id")

intron_mat <- dplyr::select(count_mat, 
                            gene_id, 
                            contains("_intron")) %>% 
  as.data.frame() %>% 
  tibble::column_to_rownames("gene_id")

ribo_libs <- mdata %>% filter(lib_type == "ribozero")
polya_libs <- mdata %>% filter(lib_type == "polyA")

exon_mats <- map(list(ribo_libs, polya_libs), 
                 ~exon_mat[, str_c(.x$run_accession, "_exon")])

intron_mats <- map(list(ribo_libs, polya_libs), 
                 ~intron_mat[, str_c(.x$run_accession, "_intron")])

# make metadata samples ordered by columns in count matrix
pdata_exons <- map(exon_mats,
             ~inner_join(data_frame(run_accession = str_replace(colnames(.x), 
                                                           "_exon", 
                                                           "")),
                    mdata, 
                    by = "run_accession") %>% 
               mutate(mzt = ifelse(as.numeric(timepoint) < 3,
                                   "maternal",
                                   "zygotic")))

# make metadata samples ordered by columns in count matrix
pdata_introns <- map(intron_mats,
             ~inner_join(data_frame(run_accession = str_replace(colnames(.x), 
                                                           "_intron", 
                                                           "")),
                    mdata, 
                    by = "run_accession") %>% 
               mutate(mzt = ifelse(as.numeric(timepoint) < 3,
                                   "maternal",
                                   "zygotic")))

mats <- c(exon_mats, intron_mats)
pdatas <- c(pdata_exons, pdata_introns)
```


```{r deseq2_lrt}
run_deseq <- function(mat, pdata, min_counts = 5, min_prop_samples = 0.50){
  dds <- DESeqDataSetFromMatrix(mat, pdata, ~mzt )
  min_expr_samples <- ncol(dds) * min_prop_samples
  expr_genes <- rowSums(counts(dds) > min_counts) > min_expr_samples
  dds <- dds[expr_genes, ] 
  dds <- DESeq(dds)
  res <- results(dds, tidy = T)
  list(deseq_obj = dds, 
       results = res)
}

de_res <- map2(mats, 
               pdatas, 
               run_deseq)

sig_genes <- map(de_res, ~filter(.x$results, 
                                    padj < 0.01) %>% 
                    pull(row)) 
sig_genes_annotated <- map(de_res, ~filter(.x$results, 
                                    padj < 0.01))
```

## Get zscores 
```{r zscores}
log_cnts <- map(de_res, 
    ~log(counts(.x$deseq_obj, normalized = T) + 1))

log_cnts <- map2(log_cnts,
                 de_res,
                function(x, y){
                  colnames(x) <- colData(y$deseq_obj)$sample_title
                  x
                })

#order by time
log_cnts <- map(log_cnts, 
               function(x){
                 ordered_cols <- left_join(data_frame(sample_title = colnames(x)),
                                           mdata,
                                           by = "sample_title") %>% 
                   select(sample_title, timepoint) %>% 
                   mutate(timepoint = as.numeric(timepoint)) %>% 
                   arrange(timepoint) %>% 
                   pull(sample_title)
                 x[, ordered_cols]
               })

sig_log_cnts <- map2(log_cnts, 
                   sig_genes,
                   function(x, y){
                     idx <- intersect(rownames(x), 
                                      y)
                     x[idx, ]})

zscores <- map(log_cnts,
               ~t(scale(t(.x))))

sig_zscores <- map2(zscores, 
                   sig_genes,
                   function(x, y){
                     idx <- intersect(rownames(x), 
                                      y)
                     x[idx, ]})

mat <- sig_zscores[[1]]
mat <- sig_log_cnts[[1]]
mat <- mat / mat[, 1]

pdf("ribozero_exon_hmap.pdf")
Heatmap(sig_zscores[[1]], name = "RiboZero Exon Expression",
        cluster_rows = T,
        cluster_columns = F,
        show_row_dend = F, 
        show_column_dend = F,
        show_row_names = F,
        show_column_names = T,
        km = 5)

dev.off()

pdf("ribozero_intron_hmap.pdf")
Heatmap(sig_zscores[[3]], name = "RiboZero Intron Expression",
        cluster_rows = T,
        cluster_columns = F,
        show_row_dend = F, 
        show_column_dend = F,
        show_row_names = F,
        show_column_names = T,
        km = 5)

dev.off()

pdf("polya_exon_hmap.pdf")
Heatmap(sig_zscores[[2]], name = "PolyA Exon Expression",
        cluster_rows = T,
        cluster_columns = F,
        show_row_dend = F, 
        show_column_dend = F,
        show_row_names = F,
        show_column_names = T,
        km = 5)

dev.off()

pdf("polya_intron_hmap.pdf")
Heatmap(sig_zscores[[4]], name = "PolyA Intron Expression",
        cluster_rows = T,
        cluster_columns = F,
        show_row_dend = F, 
        show_column_dend = F,
        show_row_names = F,
        show_column_names = T,
        km = 5)

dev.off()
```


```{r spline_fun}
library(splines)
timepoints <- sort(as.numeric(unique(mdata$timepoint)))
tpm_thresh <- 0.5
expr_deviance <- 1.10 
pre_mzt_cols <- colnames(mat)[1:2]

tpts_to_expr <- apply(mat[1:10, ], 1, 
                      function(tpm){
  tpm_thresh <- log2(mean(2^tpm[pre_mzt_cols]) * expr_deviance)
  sfun <- splinefun(timepoints, tpm)
  root <- uniroot(f = function(x) sfun(x) - tpm_thresh, 
          lower = min(tpm), upper = max(tpm))
  root$root
})
sfun <- splinefun(timepoints, unname(tmp), ties = "ordered")
pos <- uniroot(f = function(x) sfun(x) - 1, lower = min(tmp), upper = max(tmp))

df <- data_frame(timepoints,
                 dat = tmp,
                 interp_dat = sfun(tmp))

ggplot(df, aes(timepoints, 
               tmp)) 
plot(timepoints, tmp)
lines(timepoints, lapply(tmp, function(x) sfun(x)))
lines(pos$root)
```


```{r kmeans}
set.seed(20180416)
pre_km <- flexclust::kcca(sig_pre_zscores, k = 7, 
                        control = list(initcent = "kmeanspp"))
set.seed(20180408)
mat_km <- flexclust::kcca(sig_mature_zscores, k = 7, 
                        control = list(initcent = "kmeanspp"))

mature_zscores_no_na <- mature_zscores[!apply(mature_zscores, 
                                              1, 
                                              function(x)
                                                any(is.na(x))),  ]

common_genes <- intersect(rownames(sig_pre_zscores), rownames(mature_zscores_no_na))

sig_premat <- cbind(sig_pre_zscores[common_genes, ], 
                    mature_zscores_no_na[common_genes, ])

colnames(sig_premat) <- c(str_c("pre_", colnames(sig_pre_zscores)),
                          str_c("mature_", colnames(mature_zscores)))

premat_km <- flexclust::kcca(sig_premat, 
                             k = 15, 
                        control = list(initcent = "kmeanspp"))
```




```{r hmaps}
#time_order <- c(
#  "1-cell",
#  "2-cell",
#  "128-cell",
#  "1k-cell",
#  "Dome",
#  "50pc-epiboly",
#  "Shield",
#  "75pc-epiboly")
#
#reorder_ids <- colnames(sig_pre_zscores) %>% 
#  str_remove(., "-[0-9]$")  
#
#reorder_idx <- order(match(reorder_ids, time_order))
#
#sig_pre_zscores <- sig_pre_zscores[, reorder_idx]
#sig_mature_zscores <- sig_mature_zscores[, reorder_idx]
#mature_zscores_no_na <- mature_zscores_no_na[, reorder_idx]

ht1 <- Heatmap(sig_pre_zscores,
         name = "pre-mRNA abundance\nzscore",
         show_row_names = F,
         show_row_dend = F,
         split = pre_km@cluster,
         cluster_columns = F,
         column_order = colnames(sig_pre_zscores),
         km_title = "%i")

pdf("xenopus_premRNA_kmeans.pdf", width = 8)
print(ht1)
dev.off()


common_genes <- intersect(rownames(mature_zscores_no_na),
                          rownames(sig_pre_zscores))
ht1_1 <- Heatmap(sig_pre_zscores[common_genes, ],
         name = "pre-mRNA abundance\nzscore",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         split = pre_km@cluster[common_genes],
         km_title = "%i")

ht1_2 <- Heatmap(mature_zscores_no_na[common_genes, ],
         name = "mature-mRNA abundance\nzscore",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         column_order = column_order(ht1))

pdf("xenopus_pre_mRNA_kmeans_with_mat.pdf", width = 8)
print(ht1_1 + ht1_2)
dev.off()

combined_premat_zscores <- cbind(sig_pre_zscores[common_genes, ],
                       mature_zscores_no_na[common_genes, ])
                       
new_cols <- c(paste0("pre_",
                     colnames(combined_premat_zscores)[1:ncol(sig_pre_zscores)]),
              paste0("mature_",
                     colnames(combined_premat_zscores)[(ncol(sig_pre_zscores) + 1): ncol(combined_premat_zscores)]))

colnames(combined_premat_zscores) <- new_cols

ht1_1 <- Heatmap(combined_premat_zscores,
         name = "abundance\nzscore",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         split = pre_km@cluster[common_genes],
         km_title = "%i")

pdf("xenopus_pre_mRNA_kmeans_with_mature_clustered.pdf", width = 10, height = 12)
draw(ht1_1, padding = unit(c(15, 2, 2, 2), "mm"))
dev.off()

ht2 <- Heatmap(sig_mature_zscores, 
         name = "mature-mRNA abundance\nzscore",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         split = mat_km@cluster,
         km_title = "%i")
ht2

pdf("mat_mRNA_kmeans.pdf", width = 8)
print(ht2)
dev.off()


combined_time_order <-paste0(c("pre_", "mature_"), 
                             rep(time_order, each = 2))

reorder_ids <- colnames(sig_premat) %>% 
  str_remove(., "-[0-9]$") 

reorder_idx <- order(match(reorder_ids, combined_time_order))
sig_premat <- sig_premat[, reorder_idx]

ht3 <- Heatmap(sig_premat,
                name = "pre-mRNA and mRNA abundance\nzscore",
                show_row_names = F,
                show_row_dend = F,
                split = premat_km@cluster,
                cluster_columns = F,
                km_title = "%i")

pdf("pre_and_mat_mRNA_kmeans.pdf", width = 8)
draw(ht3, padding = unit(c(15, 2, 2, 2), "mm"))
dev.off()


```

### plot average profile per cluster

```{r avg_prof}
clust_ids <- pre_km@cluster

avg_profile <- sig_pre_zscores %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  left_join(., data_frame(gene_id = names(clust_ids),
                          cluster = clust_ids), by = "gene_id") %>% 
  gather(sample, zscore, -cluster, -gene_id) %>% 
  mutate(time = str_split(sample, "-[0-9]", simplify = T) %>% .[, 1],
         cluster = as.character(cluster)) %>% 
  group_by(cluster) %>% 
  mutate(n_transcripts = length(unique(gene_id))) %>% 
  group_by(cluster, time, n_transcripts) %>% 
  summarize(med_zscore = median(zscore)) %>% 
  ungroup() %>% 
  mutate(time = factor(time, 
                       levels = time_order),
         cluster = str_c(cluster, " (", formatC(n_transcripts, big.mark = ","), ")"))
  
plt <- ggplot(avg_profile, aes(time, med_zscore)) +
  geom_line(aes(group = cluster, colour = cluster),
            size = 1.5) +
  scale_color_brewer(palette = "Paired") + 
  labs(y = "Expression profile\n(median of z-scores)", x = "") + 
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.5))

save_plot("expression_per_cluster.pdf", plt, base_width = 6)
```


```{r mat_avg_prof}
clust_ids <- mat_km@cluster

avg_profile <- sig_mature_zscores %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  left_join(., data_frame(gene_id = names(clust_ids),
                          cluster = clust_ids), by = "gene_id") %>% 
  gather(sample, zscore, -cluster, -gene_id) %>% 
  mutate(time = str_split(sample, "-[0-9]", simplify = T) %>% .[, 1],
         cluster = as.character(cluster)) %>% 
  group_by(cluster) %>% 
  mutate(n_transcripts = length(unique(gene_id))) %>% 
  group_by(cluster, time, n_transcripts) %>% 
  summarize(med_zscore = median(zscore)) %>% 
  ungroup() %>% 
 mutate(time = factor(time, 
                       levels = time_order),
         cluster = str_c(cluster, " (", formatC(n_transcripts, big.mark = ","), ")"))
  
plt <- ggplot(avg_profile, aes(time, med_zscore)) +
  geom_line(aes(group = cluster, colour = cluster),
            size = 1.5) +
  scale_color_brewer(palette = "Paired") + 
  labs(y = "Expression profile\n(median of z-scores)", x = "") + 
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.5))

save_plot("matmRNA_expression_per_cluster.pdf", plt, base_width = 5.5)
```



### increased pre-mRNA not increased mature

```{r}

interesting_txs <- left_join(interest_txs,
                             data_frame(gene_id = names(pre_km@cluster),
                                        cluster = pre_km@cluster),
                             by = c("row" = "gene_id"))

shared <- intersect(rownames(mature_counts_lrt), interesting_txs$row) 

avg_profile_pre <- pre_counts_lrt[shared, ] %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  gather(sample, zscore, -gene_id) %>% 
  mutate(time = str_split(sample, "-[0-9]", simplify = T) %>% .[, 1]) %>% 
  group_by(time) %>% 
  summarize(med_zscore = median(zscore)) %>% 
  ungroup() %>% 
 mutate(time = factor(time, 
                       levels = time_order))
  

avg_profile_mature <- mature_counts_lrt[shared, ] %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  gather(sample, zscore, -gene_id) %>% 
  mutate(time = str_split(sample, "-[0-9]", simplify = T) %>% .[, 1]) %>% 
  group_by(time) %>% 
  summarize(med_zscore = median(zscore)) %>% 
  ungroup() %>% 
 mutate(time = factor(time, 
                       levels = time_order))

avg_profile <- bind_rows(`pre-mRNA` = avg_profile_pre,
                         `mature-mRNA` = avg_profile_mature,
                         .id = "cluster")

plt <- ggplot(avg_profile, aes(time, med_zscore)) +
  geom_line(aes(group = cluster, colour = cluster),
            size = 1.5) +
  scale_color_brewer(palette = "Paired", name = "") + 
  labs(y = "Expression profile\n(median of z-scores)", x = "") + 
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.5))

save_plot("premRNA_expression_no_mature_change_logexpr.pdf", plt, base_width = 5.5)

avg_profile_pre <- sig_pre_zscores[shared, ] %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  gather(sample, zscore, -gene_id) %>% 
  mutate(time = str_split(sample, "-[0-9]", simplify = T) %>% .[, 1]) %>% 
  group_by(time) %>% 
  summarize(med_zscore = median(zscore)) %>% 
  ungroup() %>% 
  mutate(time = factor(time, 
                       levels = time_order))
  

avg_profile_mature <- mature_zscores[shared, ] %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  gather(sample, zscore, -gene_id) %>% 
  mutate(time = str_split(sample, "-[0-9]", simplify = T) %>% .[, 1]) %>% 
  group_by(time) %>% 
  summarize(med_zscore = median(zscore)) %>% 
  ungroup() %>% 
  mutate(time = factor(time, 
                       levels = time_order))

avg_profile <- bind_rows(`pre-mRNA` = avg_profile_pre,
                         `mature-mRNA` = avg_profile_mature,
                         .id = "cluster")

plt <- ggplot(avg_profile, aes(time, med_zscore)) +
  geom_line(aes(group = cluster, colour = cluster),
            size = 1.5) +
  scale_color_brewer(palette = "Paired", name = "") + 
  labs(y = "Expression profile\n(median of z-scores)", x = "") + 
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.5))

save_plot("premRNA_expression_no_mature_change_zscores.pdf", plt, base_width = 5.5)
```


## out files
```{r gene_names}
tx2gene_name <- gtf %>% 
  filter(type == "gene") %>% 
  dplyr::select(gene_name, gene_id) %>% 
  unique()

pre_clusters <- data_frame(gene_id = names(pre_km@cluster),
                           cluster = pre_km@cluster)
mat_clusters <- data_frame(gene_id = names(mat_km@cluster),
                           cluster = mat_km@cluster)

pre_clusters <- left_join(pre_clusters, tx2gene_name,
                          by = "gene_id") %>% arrange(cluster)
mat_clusters <- left_join(mat_clusters, tx2gene_name,
                          by = "gene_id")  %>% arrange(cluster)

write_tsv(pre_clusters, "zebrafish_premrna_cluster_ids.tsv")
write_tsv(mat_clusters, "zebrafish_maturerna_cluster_ids.tsv")

write.table(mature_counts_lrt, 
            "zebrafish_mature_norm_counts.tsv", sep = "\t", quote = F)
write.table(pre_counts_lrt, 
            "zebrafish_pre_norm_counts.tsv", sep = "\t", quote = F)

combined_pre <- left_join(pre_clusters, 
          res_mature_lrt_tidy,
          by = c("gene_id" = "row"),
          suffix = c("", "_mature")) %>% 
  left_join(., res_pre_lrt_tidy, 
            by = c("gene_id" = "row"),
          suffix = c("", "_pre"))

write_tsv(combined_pre, "pre_mRNA_deseq.tsv")

plt_dat <- mutate(combined_pre, 
                  cluster = as.character(cluster))
mat <- ggplot(plt_dat, aes(cluster, baseMean)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(y = "baseMean mature mRNA")

pre <- ggplot(plt_dat, aes(cluster, baseMean_pre)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(y = "baseMean pre mRNA")

plot_grid(mat, pre)

```


## Compare to known genes
```{r compare_to_nature_paper}
if(!file.exists("nature12632-s1.txt")) {
  download.file("https://media.nature.com/original/nature-assets/nature/journal/v503/n7476/extref/nature12632-s1.txt", "nature12632-s1.txt")
}

lee_et_al <- read_tsv("nature12632-s1.txt", comment = "#", skip = 1)
table(lee_et_al$Maternal_contr)



if(!file.exists("elife_clusters.tst")){
  download.file("https://elifesciences.org/download/aHR0cHM6Ly9jZG4uZWxpZmVzY2llbmNlcy5vcmcvYXJ0aWNsZXMvMzA4NjAvZWxpZmUtMzA4NjAtc3VwcDUtdjEudHN2/elife-30860-supp5-v1.tsv?_hash=xtF7pnqjJLD8DKvKxzIQXrvZ0%2FEmCNOjS1LhNZxJH%2Fw%3D", 
                "elife_clusters.txt")
}
elife <- read_tsv("elife_clusters.txt")

elife_with_precluster <- left_join(pre_clusters, elife, by = "gene_id") %>% 
  left_join(., res_pre_lrt_tidy, 
            by = c("gene_id" = "row")) %>% 
  left_join(., mat_clusters, by = "gene_id") %>% 
  left_join(., res_mature_lrt_tidy, 
            by = c("gene_id" = "row")) %>% 
  left_join(., lee_et_al, by = c("gene_id" = "Gene_id"))
```


## Poly (A) Tail lengths

```{r}
dir.create("pas_seq")
download.file("https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE52809&format=file&file=GSE52809%5FDre%5Fmock%5F2hpf%2Etxt%2Egz", "pas_Seq/2hr.txt.gz")
download.file("https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE52809&format=file&file=GSE52809%5FDre%5Fmock%5F4hpf%2Etxt%2Egz", "pas_Seq/4hr.txt.gz")
download.file("https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE52809&format=file&file=GSE52809%5FDre%5Fmock%5F6hpf%2Etxt%2Egz", "pas_Seq/6hr.txt.gz")
```


```{r}
files <- dir("pas_seq", full.names = T)
pas <- map(files, read_tsv, skip = 2)
names(pas) <- basename(files) %>% str_replace(".txt.gz", "")
pas <- bind_rows(pas, .id = "time")

clusters <- read_tsv("zebrafish_premrna_cluster_ids.tsv")

pas_clusters <- inner_join(clusters, pas, by = c("gene_id" = "Gene name"))
pas_clusters <- pas_clusters %>% 
  filter(`Poly(A) tags` > 50) %>% 
  select(gene_id, gene_name, cluster, time, `Mean TL`) %>% 
  mutate(cluster = as.factor(cluster))

plt <- ggplot(pas_clusters, aes(cluster, `Mean TL`)) +
  geom_boxplot(aes(fill = time), coef = Inf) +
  labs(y = "Mean Poly(A) tail length\nSubtelny et. al.") +
  scale_fill_viridis_d()

save_plot("polya_tails.pdf", plt)
```


```{r}

download.file("http://www.biologists.com/DEV_Movies/DEV095091/DEV095091TableS7.xls", "s7.xls")

preMBT <- readxl::read_excel("s7.xls", skip = 1)

cpe_genes <- inner_join(clusters, preMBT, by = c("gene_id" = "test_id"))

group_by(cpe_genes, cluster) %>% 
  summarize(n())
```