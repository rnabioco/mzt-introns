---
title: "Zebrafish time course"
author: "Kent Riemondy RBI"
date: '`r Sys.Date()`'
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

## Zebrafish MZT analysis

A paper describing a very high resolution time course of zebrafish was published recently in eLife [A high-resolution mRNA expression time course of embryonic development in zebrafish](https://elifesciences.org/articles/30860). This dataset will likely provide additional proof of principle data for the intronic analysis performed with drosophila datasets. 

RNA-Seq data (paired-end) from 8 stages surrounding the MZT (or ZGA in zebrafish literature) was downloaded with 5 replicates per time point. The data was processed through salmon similarly to the drosophila data. In contrast to Olivia's drosphila data, these data are poly(A) purified mRNA-Seq libraries, so the intronic signal may be more subtle.  

 
## RNA-Seq Libraries
```{r load_libs}
source("../../R/globals.r")
```



```{r get_metadata}
mdata <- read_tsv(file.path(data_dir, "raw_data", "zebrafish", 
                             "WHITE", "elife-30860-supp1-v1.tsv"))

fish_pond <- file.path(data_dir, 
                           "salmon",
                           "zebrafish",
                           "WHITE")
fishes <- dir(fish_pond,
                 pattern = "quant.sf$",
                 recursive = T,
                 full.names = T)

fish_names <- str_split(fishes, "\\/") %>% map_chr(., ~.x[10])

mdata <- mdata %>% filter(public_name %in% fish_names)
mdata
```


## Alignment %

```{r alignment}

alignment <- map(fish_names, 
                  ~fromJSON(txt = file.path(
                    fish_pond, 
                          .x, 
                          "aux_info", 
                          "meta_info.json")) %>% .$percent_mapped)

alignment <- data_frame(fish_names,
                        percent_mapped = unlist(alignment))


inner_join(alignment, 
          mdata, 
          by = c("fish_names" = "public_name"))
```

## Load in salmon data

```{r load_dat, message = F}

dat <- map(fishes, read_tsv)

# name with libraryID
names(dat) <- fish_names

dat <- bind_rows(dat, .id = "public_name")

#join with main data
dat <- inner_join(dat, 
                 mdata,
                by = c("public_name"))
```

### transcript to gene mapping
```{r drop_monoexonic}
gtf <- "~/Projects/shared_dbases/annotation/zebrafish/GRCz10/Danio_rerio.GRCz10.91.gtf"
gtf <- import(gtf)
gtf <- as.data.frame(gtf)

gtf_summary <- dplyr::filter(gtf, type == "exon") %>% 
  dplyr::select(seqnames, start, end, strand, gene_id) %>% 
  dplyr::rename(chrom = seqnames) %>% 
  unique() %>% 
  group_by(gene_id) %>% 
  bed_merge() %>% 
  dplyr::summarize(total_exons = n())

monoexonic_genes <- dplyr::filter(gtf_summary, total_exons == 1) %>% pull(gene_id)
```


```{r remove_monoexonic}

dat <- anti_join(dat, 
                    data_frame(gene_id = monoexonic_genes),
                 by = c("Name" = "gene_id"))

# classify transcripts as primary or mature
dat %>% 
  mutate(type = ifelse(str_detect(Name, 
                                  "^pre_"), 
                       "pre", "mature")) -> dat

# drop unneeded data
dat <- dplyr::select(dat,
                     -c(Length:EffectiveLength, 
                        NumReads))

gene2tx <- gtf[, c("gene_id", "transcript_id")]
gene2tx <- unique(gene2tx)
gene2tx <- na.omit(gene2tx)

# add in geneid attribute
dat <- left_join(dat, gene2tx, by = c("Name" = "transcript_id")) %>% 
  dplyr::rename(transcript_id = Name)

# add geneid attribute for pre_ annotations

dat <- mutate(dat, 
              gene_id = ifelse(type == "pre",
                               str_replace(transcript_id, "^pre_", ""),
                               gene_id))

dat <- mutate(dat,
              monoexonic = gene_id %in% monoexonic_genes)
```

### plot pre_mRNA ratio

```{r, calc_premRNA}
# sum primary and mature TPMs for each gene 
summary_dat <- dplyr::select(dat, TPM, gene_id, 
              public_name, type, stageName, sampleName) %>% 
  group_by(gene_id, public_name, type) %>% 
  dplyr::summarize(total_tpm = sum(TPM, na.rm = F),
                   sampleName = unique(sampleName),
                   stageName = unique(stageName)) %>% 
  ungroup() 

## calc primary ratio
tpm_summary <- summary_dat %>% 
  spread(type, total_tpm) %>% 
  mutate(primary_ratio  = pre / (mature + pre))

## calc mean primary ratio
tpm_means <- tpm_summary %>% 
  group_by(gene_id, 
           stageName) %>% 
  summarize(mean_primary = mean(primary_ratio,
                                na.rm = T)) 

tpm_means <- mutate(tpm_means, 
                       stage = factor(stageName, 
                                         levels = c(
                                           "1-cell",
                                           "2-cell",
                                           "128-cell",
                                           "1k-cell",
                                           "Dome",
                                           "50pc-epiboly",
                                           "Shield",
                                           "75pc-epiboly")
                                         )
                       )


tpm_means <- dplyr::ungroup(tpm_means)

plt <- ggplot(tpm_means, 
       aes(stage, mean_primary)) +
  geom_boxplot(aes(fill = stage), coef = 1e3) + 
  labs(x = "",
       y = expression(frac("pre-mRNA TPM", 
                           "mature + pre-mRNA TPM"))) +
  scale_fill_brewer(palette = "Set1",
                    name = "Transcript Type",
                    breaks = c("pre", "mature"),
                    labels = c("pre-mRNA", "mature-mRNA")) +
  theme(
    axis.text.x = element_text(angle = 90,
                               vjust = 0.5,
                               hjust = 0.5)
  )

plt
```

There is a very clear increase between the 1k-cell and Dome stages, which are pre and post-MZT stages (3hpf and 4.3hpf respectively).


## Classify transcripts into maternal or zygotic

Next I'll try to classify transcripts into catagories based upon their abundance changes throughout embryogenesis. 

First generate salmon quant.sf files for pre-mRNAs or mature mRNAs independently for loading into `tximport`
```{r, split_salmon}

tx2gene_mapping <- dplyr::select(dat, 
                         transcript_id, 
                         gene_id) %>% 
  unique() %>% 
  as.data.frame()

all_dat <- map(fishes, read_tsv)

all_pre <- map(all_dat, 
                 ~dplyr::filter(.x,
                                str_detect(Name, "^pre_")))

all_mat <- map(all_dat, 
               ~dplyr::filter(.x,
                              !str_detect(Name, "^pre_")))

dir.create("salmon_modified", recursive = T)

walk2(all_pre,
      fish_names,
      ~write_tsv(.x, file.path("salmon_modified", 
                               paste0(.y, ".premRNA"))))
walk2(all_mat,
      fish_names,
      ~write_tsv(.x, file.path("salmon_modified", 
                               paste0(.y, ".maturemRNA"))))
```


```{r}
files <- dir("salmon_modified", full.names = T)

mature <- str_subset(files, "maturemRNA$")
pre <- str_subset(files, "premRNA$")

matures <- tximport(mature, 
         type = "salmon",
         tx2gene = tx2gene_mapping)

pres <- tximport(pre, 
         type = "salmon",
         tx2gene = tx2gene_mapping)

# make metadata sample ordered by columns in count matrix
pdata <- inner_join(data_frame(public_name = fish_names),
           mdata, by = "public_name")

pdata <- mutate(pdata, 
                mzt = ifelse(str_detect(stageName,
                                        "-cell"),
                             "maternal",
                             "zygotic"),
                stageName = str_replace(stageName, "-", "_"))
```


```{r deseq2}

dds <- DESeqDataSetFromTximport(matures, pdata, ~mzt)
dds_mature <- DESeq(dds)
res_mature <- results(dds_mature)
res_mature_tidy <- results(dds_mature, tidy = TRUE)

dds <- DESeqDataSetFromTximport(pres, pdata, ~mzt)
dds_pre <- DESeq(dds)
res_pre <- results(dds_pre)
res_pre_tidy <- results(dds_pre, tidy = TRUE)
```

```{r plot_MAs}
pre_plot_dat <- res_pre_tidy %>% 
  as_tibble() %>% 
  mutate(sig = ifelse(padj < 0.05 & log2FoldChange > 0, "Up", 
                      ifelse(padj < 0.05 & log2FoldChange < 0, "Down", "Not Sig")))
n_sig_up <- nrow(dplyr::filter(pre_plot_dat, sig == "Up")) %>% 
  formatC(big.mark = ",")
n_sig_down <- nrow(dplyr::filter(pre_plot_dat, sig == "Down"))  %>% 
  formatC(big.mark = ",")
n_notsig <- nrow(dplyr::filter(pre_plot_dat, sig == "Not Sig"))  %>% 
  formatC(big.mark = ",")

p <- ggplot(pre_plot_dat, 
       aes(baseMean, log2FoldChange)) +
  geom_point(aes(colour = sig), size = 0.1) +
  scale_colour_viridis(discrete = TRUE,
                       name = "",
                       labels = c(paste0("Sig down (n = ", n_sig_down, ")"),
                                  paste0("Not Sig (n= ", n_notsig, ")"),
                                  paste0("Sig up (n = ", n_sig_up, ")"))) +
  scale_x_log10() + 
  labs(x = expression(paste("log"[10], " Average Expression")),
       y = expression(paste("log"[2], " ", frac("Zygotic", "Maternal"))),
       title = "pre-mRNA") +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "top")
  
p

mature_plot_dat <- res_mature_tidy %>% 
  as_tibble() %>% 
  mutate(sig = ifelse(padj < 0.05 & log2FoldChange > 0, "Up", 
                      ifelse(padj < 0.05 & log2FoldChange < 0, "Down", "Not Sig")))
n_sig_up <- nrow(dplyr::filter(mature_plot_dat, sig == "Up")) %>% 
  formatC(big.mark = ",")
n_sig_down <- nrow(dplyr::filter(mature_plot_dat, sig == "Down"))  %>% 
  formatC(big.mark = ",")
n_notsig <- nrow(dplyr::filter(mature_plot_dat, sig == "Not Sig"))  %>% 
  formatC(big.mark = ",")

p <- ggplot(mature_plot_dat, 
       aes(baseMean, log2FoldChange)) +
  geom_point(aes(colour = sig), size = 0.1) +
  scale_colour_viridis(discrete = TRUE,
                       name = "",
                       labels = c(paste0("Sig down (n = ", n_sig_down, ")"),
                                  paste0("Not Sig (n= ", n_notsig, ")"),
                                  paste0("Sig up (n = ", n_sig_up, ")"))) +
  scale_x_log10() + 
  labs(x = expression(paste("log"[10], " Average Expression")),
       y = expression(paste("log"[2], " ", frac("Zygotic", "Maternal"))),
       title = "mature-mRNA") +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "top")
  
p
```


```{r plot_zyg_mat_pre}
library(eulerr)

sig_mat_up <- res_mature_tidy %>% filter(padj < 0.05, log2FoldChange > 0)
sig_pre_up <- res_pre_tidy %>% filter(padj < 0.05, log2FoldChange > 0)
all_sig_up <- union(sig_mat_up$row, sig_pre_up$row)
lgl_up_df <- data.frame(
  `mature_mRNA` =  all_sig_up %in% sig_mat_up$row,
  `pre_mRNA` =  all_sig_up %in% sig_pre_up$row
)

sig_mat_down <- res_mature_tidy %>% filter(padj < 0.05, log2FoldChange < 0)
sig_pre_down <- res_pre_tidy %>% filter(padj < 0.05, log2FoldChange < 0)
all_sig_down <- union(sig_mat_down$row, sig_pre_down$row)
lgl_down_df <- data.frame(
  `mature_mRNA` =  all_sig_down %in% sig_mat_down$row,
  `pre_mRNA` =  all_sig_down %in% sig_pre_down$row
)

fit_up <- euler(lgl_up_df)
fit_down <- euler(lgl_down_df)

plot(fit_up, fill = viridis(2), quantities = TRUE, main = "Increased abundance in Zygotic Stages")
plot(fit_down, fill = viridis(2), quantities = TRUE, main = "Decreased abundance in Zygotic Stages")
```


```{r write_out_sig}
write_tsv(res_pre_tidy, "deseq_results_pre.tsv")
write_tsv(res_mature_tidy, "deseq_results_mature.tsv")

```


```{r hmap_intronic_only, fig.height = 14, fig.width = 8}
interest_txs <- sig_pre_up[!sig_pre_up$row %in% sig_mat_up$row, ]

dds_pre_rlogs <- rlog(dds_pre)

# add in colnames
cols <- pdata %>% 
  pull(sampleName)

rlog_counts_pre <- assay(dds_pre_rlogs)
colnames(rlog_counts_pre) <- cols

dds_mat_rlogs <- rlog(dds_mature)

# add in colnames
cols <- pdata %>% 
  pull(sampleName)

rlog_counts_mat <- assay(dds_mat_rlogs)
colnames(rlog_counts_mat) <- cols

common_genes <- intersect(rownames(rlog_counts_pre),rownames(rlog_counts_mat))
rlog_counts_pre <- rlog_counts_pre[common_genes, ]
rlog_counts_mat <- rlog_counts_mat[common_genes, ]
 
sig_pre_rlogs <- rlog_counts_pre[rownames(rlog_counts_pre) %in% interest_txs$row, ]
sig_mat_rlogs <- rlog_counts_mat[rownames(rlog_counts_mat) %in% interest_txs$row, ]

ht1 <- Heatmap(sig_pre_rlogs, 
         name = "pre-mRNA abundance\nrlog",
         show_row_names = F,
         show_row_dend = F)

ht2 <- Heatmap(sig_mat_rlogs, 
         name = "mature-mRNA abundance\nrlog",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         column_order = column_order(ht1))

draw(ht1 + ht2, column_title = "Increased pre-mRNA \nnot Increased mature")
```


```{r increased_pre_mRNA, fig.height = 14, fig.width = 8}

sig_pre_rlogs <- rlog_counts_pre[rownames(rlog_counts_pre) %in% sig_pre_up$row, ]
sig_mat_rlogs <- rlog_counts_mat[rownames(rlog_counts_mat) %in% sig_mat_up$row, ]

ht1 <- Heatmap(sig_pre_rlogs, 
         name = "pre-mRNA abundance\nrlog",
         show_row_names = F,
         show_row_dend = F)
ht1
ht2 <- Heatmap(sig_mat_rlogs, 
         name = "mature-mRNA abundance\nrlog",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         column_order = column_order(ht1))
ht2
```

Try to order by time to induction...

Examine two time point delta intron delta exon


```{r delta_intron, fig.width - 16, fig.height= 16}
mat_norm_counts <- counts(dds_mature, normalized = T)
pre_norm_counts <- counts(dds_pre, normalized = T)

common_genes <- intersect(rownames(mat_norm_counts), rownames(pre_norm_counts))
mat_norm_counts <- mat_norm_counts[common_genes, ] + pre_norm_counts[common_genes, ]
pre_norm_counts <- pre_norm_counts[common_genes, ]


plot_fun <- function(x, y, sig, plt_title = "title") {
  dat <- data_frame(x, y, label = sig)
  ggplot(dat, aes(x, y)) +
    geom_point(aes(color = label)) +
    coord_equal() +
    labs(title  = plt_title)
}

delta_mature <- log2(mat_norm_counts + 1) - log2(rowMeans(mat_norm_counts) + 1)
delta_pre <- log2(pre_norm_counts + 1) - log2(rowMeans(pre_norm_counts) + 1)

colnames(delta_mature) <- colData(dds_mature)$sampleName
colnames(delta_pre) <- colData(dds_pre)$sampleName

plts <- map(1:ncol(delta_mature), ~plot_fun(delta_pre[, .x], 
                                    delta_mature[, .x], 
                                    rownames(delta_pre) %in% sig_mat_up$row,
            plt_title = colnames(delta_mature)[.x]))

plot_grid(plotlist = plts, rel_widths = 4, rel_heights = 4)
```


Strictly maternal:

```{r maternal, fig.width - 16, fig.height= 16}

# genes decreased or not -sidnificant post-MZT based on pre-mRNA
pres <- res_pre_tidy %>% filter(log2FoldChange < 0 | padj  > 0.05)
mats <- res_mature_tidy %>% filter(log2FoldChange < 0,
                                   padj < 0.05)
strictly_mat <- intersect(pres$row, mats$row)
Heatmap(rlog_counts_mat[rownames(rlog_counts_mat) %in% strictly_mat, ], 
         name = "mature-mRNA abundance\nrlog",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = T)


Heatmap(rlog_counts_pre[rownames(rlog_counts_pre) %in% strictly_mat, ], 
         name = "mature-mRNA abundance\nrlog",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = T)



delta_mat_mature <- delta_mature[rownames(delta_mature) %in% strictly_mat, ]
delta_mat_pre <- delta_pre[rownames(delta_pre) %in% strictly_mat, ]

plts <- map(1:ncol(delta_mat_mature), ~plot_fun(delta_mat_pre[, .x], 
                                    delta_mat_mature[, .x], 
                                    rownames(delta_mat_pre) %in% sig_mat_down$row,
            plt_title = colnames(delta_mat_pre)[.x]))

plot_grid(plotlist = plts, rel_widths = 4, rel_heights = 4)
```


## Factor time course analysis


```{r}
files <- dir("salmon_modified", full.names = T)

mature <- str_subset(files, "maturemRNA$")
pre <- str_subset(files, "premRNA$")

matures <- tximport(mature, 
         type = "salmon",
         tx2gene = tx2gene_mapping)

pres <- tximport(pre, 
         type = "salmon",
         tx2gene = tx2gene_mapping)

# make metadata sample ordered by columns in count matrix
pdata <- inner_join(data_frame(public_name = fish_names),
           mdata, by = "public_name")

pdata <- mutate(pdata, 
                mzt = ifelse(str_detect(stageName,
                                        "-cell"),
                             "maternal",
                             "zygotic"),
                stageName = str_replace(stageName, "-", "_"))
```


```{r deseq2_lrt}

dds <- DESeqDataSetFromTximport(matures, pdata, ~stageName)
dds_mature <- DESeq(dds)
res_mature <- results(dds_mature)
res_mature_lrt_tidy <- results(dds_mature, tidy = TRUE)

dds <- DESeqDataSetFromTximport(pres, pdata, ~stageName)
dds_pre <- DESeq(dds)
res_pre <- results(dds_pre)
res_pre_lrt_tidy <- results(dds_pre, tidy = TRUE)
```


```{r zscores}
library(flexclust) #kmeans++
mature_counts_lrt <- log2(counts(dds_mature, normalized =T) + 1)
pre_counts_lrt <- log2(counts(dds_pre, normalized = T) + 1)

colnames(mature_counts_lrt) <- colData(dds_mature)$sampleName
colnames(pre_counts_lrt) <- colData(dds_pre)$sampleName

mature_zscores <- t(scale(t(mature_counts_lrt)))
pre_zscores <- t(scale(t(pre_counts_lrt)))

sig_pre <- res_pre_lrt_tidy[res_pre_lrt_tidy$padj < 0.01, ]
sig_mat <- res_mature_lrt_tidy[res_mature_lrt_tidy$padj < 0.01, ]

sig_pre_zscores <- pre_zscores[rownames(pre_zscores) %in% sig_pre$row, ]
sig_mature_zscores <- mature_zscores[rownames(mature_zscores) %in% sig_mat$row, ] 
```

```{r check_cluster_n}
mydata <- sig_pre_zscores
wss <- (nrow(mydata)-1) * sum(apply(mydata,2,var))
for (i in 2:15) {
  wss[i] <- sum(kmeans(mydata, centers=i)$withinss)
}
dat <- data_frame(Within_sum_of_squares = wss,
                  n_cluster = seq_along(1:length(wss)))

ggplot(dat,
       aes(n_cluster, Within_sum_of_squares)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks = pretty(dat$n_cluster, n = 10))
```


```{r kmeans}
set.seed(20180416)
pre_km <- flexclust::kcca(sig_pre_zscores, k = 7, 
                        control = list(initcent = "kmeanspp"))
set.seed(20180408)
mat_km <- flexclust::kcca(sig_mature_zscores, k = 7, 
                        control = list(initcent = "kmeanspp"))
set.seed(20180408)

mature_zscores_no_na <- mature_zscores[!apply(mature_zscores, 
                                              1, 
                                              function(x)
                                                any(is.na(x))),  ]
common_genes <- intersect(rownames(sig_pre_zscores), rownames(mature_zscores_no_na))

sig_premat <- cbind(sig_pre_zscores[common_genes, ], 
                    mature_zscores_no_na[common_genes, ])

colnames(sig_premat) <- c(str_c("pre_", colnames(sig_pre_zscores)),
                          str_c("mature_", colnames(mature_zscores)))

premat_km <- flexclust::kcca(sig_premat, 
                             k = 15, 
                        control = list(initcent = "kmeanspp"))
```




```{r hmaps}
time_order <- c(
  "1-cell",
  "2-cell",
  "128-cell",
  "1k-cell",
  "Dome",
  "50pc-epiboly",
  "Shield",
  "75pc-epiboly")

reorder_ids <- colnames(sig_pre_zscores) %>% 
  str_remove(., "-[0-9]$")  

reorder_idx <- order(match(reorder_ids, time_order))

sig_pre_zscores <- sig_pre_zscores[, reorder_idx]
sig_mature_zscores <- sig_mature_zscores[, reorder_idx]

ht1 <- Heatmap(sig_pre_zscores,
         name = "pre-mRNA abundance\nzscore",
         show_row_names = F,
         show_row_dend = F,
         split = pre_km@cluster,
         cluster_columns = F,
         column_order = colnames(sig_pre_zscores),
         km_title = "%i")

pdf("premRNA_kmeans.pdf", width = 8)
print(ht1)
dev.off()


common_genes <- intersect(rownames(sig_mature_zscores),
                          rownames(sig_pre_zscores))
ht1_1 <- Heatmap(sig_pre_zscores[common_genes, ],
         name = "pre-mRNA abundance\nzscore",
         show_row_names = F,
         show_row_dend = F,
         split = pre_km@cluster[common_genes],
         km_title = "%i")

ht1_2 <- Heatmap(sig_mature_zscores[common_genes, ],
         name = "mature-mRNA abundance\nzscore",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         column_order = column_order(ht1))

pdf("pre_mRNA_kmeans_with_mat.pdf", width = 8)
print(ht1_1 + ht1_2)
dev.off()

combined_premat_zscores <- cbind(sig_pre_zscores[common_genes, ],
                       sig_mature_zscores[common_genes, ])
                       
new_cols <- c(paste0("pre_",
                     colnames(combined_premat_zscores)[1:ncol(sig_pre_zscores)]),
              paste0("mature_",
                     colnames(combined_premat_zscores)[(ncol(sig_pre_zscores) + 1): ncol(combined_premat_zscores)]))

colnames(combined_premat_zscores) <- new_cols

ht1_1 <- Heatmap(combined_premat_zscores,
         name = "abundance\nzscore",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         split = pre_km@cluster[common_genes],
         km_title = "%i")

pdf("pre_mRNA_kmeans_with_mature_clustered.pdf", width = 8)
print(ht1_1)
dev.off()

ht2 <- Heatmap(sig_mature_zscores, 
         name = "mature-mRNA abundance\nzscore",
         show_row_names = F,
         show_row_dend = F,
         split = mat_km@cluster,
         km_title = "%i")
ht2

pdf("mat_mRNA_kmeans.pdf", width = 8)
print(ht2)
dev.off()


combined_time_order <-paste0(c("pre_", "mature_"), 
                             rep(time_order, each = 2))

reorder_ids <- colnames(sig_premat) %>% 
  str_remove(., "-[0-9]$") 

reorder_idx <- order(match(reorder_ids, combined_time_order))
sig_premat <- sig_premat[, reorder_idx]

ht3 <- Heatmap(sig_premat,
                name = "pre-mRNA and mRNA abundance\nzscore",
                show_row_names = F,
                show_row_dend = F,
                split = premat_km@cluster,
                cluster_columns = F,
                km_title = "%i")

pdf("pre_and_mat_mRNA_kmeans.pdf", width = 8)
print(ht3)
dev.off()


```


```{r gene_names}
tx2gene_name <- gtf %>% 
  filter(type == "gene") %>% 
  select(gene_name, gene_id) %>% 
  unique()

pre_clusters <- data_frame(gene_id = names(pre_km@cluster),
                           cluster = pre_km@cluster)
mat_clusters <- data_frame(gene_id = names(mat_km@cluster),
                           cluster = mat_km@cluster)

pre_clusters <- left_join(pre_clusters, tx2gene_name,
                          by = "gene_id") %>% arrange(cluster)
mat_clusters <- left_join(mat_clusters, tx2gene_name,
                          by = "gene_id")  %>% arrange(cluster)

write_tsv(pre_clusters, "premrna_cluster_ids.tsv")
write_tsv(mat_clusters, "maturerna_cluster_ids.tsv")
```