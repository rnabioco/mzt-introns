---
title: "Examine intronic signals during MZT in Drosophila embryos"
author: "Kent Riemondy RBI"
date: '`r Sys.Date()`'
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

## Background

The Maternal to Zygotic Transistion (MZT) is a developmental stage in which the embryo initiates transcription of mRNAs from the zygotic genome. Maternally deposited mRNAs begin to be degraded and are replaced by zygotic messages. 

Zygotic mRNAs can be distinguished from maternal mRNAs, due to the presence or higher proportions of introns. Maternally derived mRNAs are likely to be spliced, and any remaining intron lariat degraded prior to fertilization. In contrast zygotic transcription will produce mRNAs in that need to be spliced, and thus there will be some proportion of unspliced mRNA, and intron lariat derivied from the zygotic transcripts. 

Using ribo-zero depleted total-RNA-Seq libraries, one would expect to be able to recover intronic mRNA fragements, and be able to assign for each transcript, the relative proportion of each transcript that is maternally or zygotically derived. 


## Approach

Each total RNA-Seq lib was trimmed to remove Tru-Seq adapters (Rissland libraries), or barcodes and custom 3' adapter (Bartel libraries). The trimmed reads were then processed with `salmon` to estimate `TPMs` for each transcript. The `salmon` transcript database was modified to include a pre-mRNA entry, which was designated as an exon that spanned the entire gene. This pre-mRNA annotation matches the `gene` entry from the annotaiton file. By including the pre-mRNA transcript in the `salmon` database, one can get an estimate of the fraction of pre-mRNA or mature mRNA present in each sample. 

First we'll examine the extent to which pre-mRNA transcripts increase during embryonic development. Then, if a clear increase is present, we can classify transcripts into a % maternal and % zygotic, and additional classify the temporal pattern of zygotic transcription i.e. are there distinct sets of early versus late transcripts, and do their transcriptional pattern suggest function (TF transcription prior to target activation/repression, miRNA transcription before target repression, RBP transcription prior to translational control, etc.)

 
## RNA-Seq Libraries
```{r load_libs}
source("../../R/globals.r")
```



```{r get_metadata}
mdata1 <- read_tsv(file.path(data_dir, "raw_data", "drosophila", "EICHHORN", "GSE83616_run_info_geo.txt"))
mdata2 <- read_tsv(file.path(data_dir, "raw_data", "drosophila", "RISSLAND", "GSE98106_run_info_geo.txt"))

#simplify mdata
mdata1 <- dplyr::select(mdata1,
                       Run_s, 
                       developmental_stage_s,
                       genotype_s,
                       source_name_s,
                       Assay_Type_s)

#simplify mdata
mdata2 <- dplyr::select(mdata2,
                       Run_s, 
                       developmental_stage_s,
                       rip_antibody_s,
                       source_name_s,
                       strain_s)

# select relevant libs
mdata2 <- dplyr::filter(mdata2,
                     source_name_s == "Embryo",
                     strain_s %in% c("w1118", "eGFP-ME31B"),
                     rip_antibody_s == "none") %>% 
  dplyr::select(-rip_antibody_s)

mdata1 <- dplyr::filter(mdata1,
                     genotype_s == "wt",
                     Assay_Type_s == "RNA-Seq") %>% 
  dplyr::select(-Assay_Type_s) %>% 
  dplyr::rename(strain_s = genotype_s)


mdata <- list(mdata1, mdata2)
names(mdata) <- c("EICHHORN", "RISSLAND")

mdata <- bind_rows(mdata, .id = "study")
#cleanup names
mdata <- mdata %>% 
  mutate(source_name_s = ifelse(source_name_s == "embryos", 
                                "Embryo",
                                source_name_s),
         developmental_stage_s = str_replace(developmental_stage_s,
                                             " h ",
                                             " hr "))

# cleanup colnames
colnames(mdata) <- str_replace(colnames(mdata),
                               "_s$",
                               "")

mdata
```


## Alignment %

```{r alignment}

alignment <- map2(mdata$Run, 
                 mdata$study,
                  ~fromJSON(txt = file.path(data_dir,
                          "salmon", 
                          "drosophila",
                          .y,
                          .x, 
                          "aux_info", 
                          "meta_info.json")) %>% .$percent_mapped)

alignment <- data_frame(library = mdata$Run,
                        percent_mapped = unlist(alignment))


inner_join(alignment, 
          mdata, 
          by = c("library" = "Run"))
```

## Load in salmon data

```{r load_dat, message = F}
files <- dir(file.path(data_dir, "salmon", "drosophila"),
            recursive = T,
            pattern = "*quant.sf",
            full.names = T)

dat <- map(files, read_tsv)

# name with libraryID
names(dat) <- dirname(files) %>% 
  str_split(., "[/]", simplify = T) %>% 
  .[, 10]

dat <- bind_rows(dat, .id = "libraryID")

#join with main data
dat <- inner_join(dat, 
                 mdata,
                by = c("libraryID" = "Run"))
```

### transcript to gene mapping
```{r drop_monoexonic}
gtf <- "~/Projects/shared_dbases/annotation/drosophila/Drosophila_melanogaster.BDGP6.84.gtf"
gtf <- import(gtf)
gtf <- as.data.frame(gtf)

gtf_summary <- dplyr::filter(gtf, type == "exon") %>% 
  dplyr::select(seqnames, start, end, strand, gene_id) %>% 
  dplyr::rename(chrom = seqnames) %>% 
  unique() %>% 
  group_by(gene_id) %>% 
  bed_merge() %>% 
  dplyr::summarize(total_exons = n())

monoexonic_genes <- dplyr::filter(gtf_summary, total_exons == 1) %>% pull(gene_id)
```


```{r remove_monoexonic}

dat <- anti_join(dat, 
                    data_frame(gene_id = monoexonic_genes),
                 by = c("Name" = "gene_id"))

# classify transcripts as primary or mature
dat %>% 
  mutate(type = ifelse(str_detect(Name, 
                                  "^pre_"), 
                       "pre", "mature")) -> dat

# drop unneeded data
dat <- dplyr::select(dat,
                     -c(Length:EffectiveLength, 
                        NumReads))

gene2tx <- gtf[, c("gene_id", "transcript_id")]
gene2tx <- unique(gene2tx)
gene2tx <- na.omit(gene2tx)

# add in geneid attribute
dat <- left_join(dat, gene2tx, by = c("Name" = "transcript_id")) %>% 
  dplyr::rename(transcript_id = Name)

# add geneid attribute for pre_ annotations

dat <- mutate(dat, 
              gene_id = ifelse(type == "pre",
                               str_replace(transcript_id, "^pre_", ""),
                               gene_id))

dat <- mutate(dat,
              monoexonic = gene_id %in% monoexonic_genes)
```

### plot pre_mRNA ratio

```{r, calc_premRNA}
# sum primary and mature TPMs for each gene 
summary_dat <- dplyr::select(dat, TPM, gene_id, 
              libraryID, type, developmental_stage,
              study, strain) %>% 
  group_by(gene_id, libraryID, 
           developmental_stage, type,
           strain) %>% 
  dplyr::summarize(total_tpm = sum(TPM, na.rm = F)) %>% 
  ungroup() 

## calc primary ratio
tpm_summary <- summary_dat %>% 
  spread(type, total_tpm) %>% 
  mutate(primary_ratio  = pre / (mature + pre))


## calc mean primary ratio
tpm_means <- tpm_summary %>% 
  group_by(gene_id, 
           developmental_stage,
           strain) %>% 
  summarize(mean_primary = mean(primary_ratio,
                                na.rm = T)) 

tpm_means <- mutate(tpm_means, 
                       stage = factor(developmental_stage, 
                                         levels = c(
                                           "Stage 11 oocyte",
                                           "Stage 12 oocyte",
                                           "Stage 13 oocyte",
                                           "Stage 14 oocyte",
                                           "Activated egg",
                                           "0-1 hr embryo",
                                           "1-2 hr embryo",
                                           "2-3 hr embryo",
                                           "3-4 hr embryo",
                                           "4-5 hr embryo",
                                           "5-6 hr embryo")
                                         )
                       )

tpm_means <- mutate(tpm_means,
                       strain = ifelse(strain == "wt",
                                       paste(strain, 
                                             "(Eichhorn)"),
                                       paste(strain,
                                             "(Rissland)")))
                                        
tpm_means %>% 
  group_by(gene_id, developmental_stage) %>% 
  summarize(mean_primary = mean(mean_primary, na.rm = T)) %>% 
  mutate(strain = "all strains") %>% 
  bind_rows(tpm_means, .) %>% 
  arrange(gene_id) %>% 
  ungroup() -> all_combined

ggplot(all_combined, 
       aes(developmental_stage, mean_primary)) +
  geom_boxplot(aes(fill = developmental_stage), coef = 1e3) + 
  facet_grid(~strain, scale = "free") +
  labs(x = "",
       y = expression(frac("pre-mRNA TPM", 
                           "mature + pre-mRNA TPM"))) +
  scale_fill_brewer(palette = "Set1",
                    name = "Transcript Type",
                    breaks = c("pre", "mature"),
                    labels = c("pre-mRNA", "mature-mRNA")) +
  theme(
    axis.text.x = element_text(angle = 90,
                               vjust = 0.5,
                               hjust = 0.5)
  )


all_combined <- mutate(all_combined,
                       developmental_stage = factor(developmental_stage,
                                                    levels = c(
                                                      "Stage 11 oocyte",
                                                      "Stage 12 oocyte",
                                                      "Stage 13 oocyte",
                                                      "Stage 14 oocyte",
                                                      "Activated egg",
                                                      "0-1 hr embryo",
                                                      "1-2 hr embryo",
                                                      "2-3 hr embryo",
                                                      "3-4 hr embryo",
                                                      "4-5 hr embryo",
                                                      "5-6 hr embryo")))


plt <- ggplot(filter(all_combined, strain != "all strains"), 
       aes(developmental_stage, mean_primary)) +
  geom_boxplot(aes(fill = developmental_stage), coef = 1e3) + 
  facet_grid(~strain, scale = "free") +
  labs(x = "",
       y = expression(frac("pre-mRNA TPM", 
                           "mature + pre-mRNA TPM"))) +
  scale_fill_brewer(palette = "Paired",
                    name = "Transcript Type",
                    breaks = c("pre", "mature"),
                    labels = c("pre-mRNA", "mature-mRNA")) +
  theme(
    axis.text.x = element_text(angle = 90,
                               vjust = 0.5,
                               hjust = 0.5),
    strip.text = element_text(size = 8)
  )

save_plot("pre-mRNA-ratios.pdf", plt, base_width = 6, base_height = 4.5)
```

## Classify transcripts into maternal or zygotic

Next I'll try to classify transcripts into catagories based upon their abundance changes throughout embryogenesis. 

First need to identify transcripts that are differentially expressed between maternal and zygotic states. Let's try a two state comparison of 
pre MZT and post MZT, which based on the correlation matrix shown above, is strongly segregated between the two.

First generate salmon quant.sf files for pre-mRNAs or mature mRNAs independently for loading into `tximport`
```{r, split_salmon}

tx2gene_mapping <- dplyr::select(dat, 
                         transcript_id, 
                         gene_id) %>% 
  unique() %>% 
  as.data.frame()

files <- dir(file.path(data_dir, "salmon"),
            recursive = T,
            pattern = "*quant.sf",
            full.names = T)

sra_ids <- dirname(files) %>% 
  str_split(., "/", simplify = T) %>% 
  .[, 10]

keep <- sra_ids %in% mdata$Run
files <- files[keep]
sra_ids <- sra_ids[keep]

all_dat <- map(files, read_tsv)

all_pre <- map(all_dat, 
                 ~dplyr::filter(.x,
                                str_detect(Name, "^pre_")))

all_mat <- map(all_dat, 
               ~dplyr::filter(.x,
                              !str_detect(Name, "^pre_")))

dir.create("salmon_modified", recursive = T)

walk2(all_pre,
      sra_ids,
      ~write_tsv(.x, file.path("salmon_modified", 
                               paste0(.y, ".premRNA"))))
walk2(all_mat,
      sra_ids,
      ~write_tsv(.x, file.path("salmon_modified", 
                               paste0(.y, ".maturemRNA"))))
```


```{r}
files <- dir("salmon_modified", full.names = T)

mature <- str_subset(files, "maturemRNA$")
pre <- str_subset(files, "premRNA$")

matures <- tximport(mature, 
         type = "salmon",
         tx2gene = tx2gene_mapping)

pres <- tximport(pre, 
         type = "salmon",
         tx2gene = tx2gene_mapping)

# make metadata sample ordered by columns in count matrix
pdata <- inner_join(data_frame(Run = sra_ids),
           mdata, by = "Run")

pdata <- mutate(pdata, 
                mzt = ifelse(str_detect(developmental_stage,
                                        "^[2345]-[3456] hr embryo"),
                             "zygotic",
                             "maternal"),
                strain_id = str_replace(strain, "-", "_"))
```


```{r deseq2}

dds <- DESeqDataSetFromTximport(matures, pdata, ~mzt + strain_id)
dds <- dds[ rowSums(counts(dds)) > 50, ] 
dds_mature <- DESeq(dds, test = "LRT", reduced = ~strain_id)
res_mature <- results(dds_mature, name = "mzt_zygotic_vs_maternal")
res_mature_tidy <- results(dds_mature, name = "mzt_zygotic_vs_maternal", tidy = TRUE)

dds <- DESeqDataSetFromTximport(pres, pdata, ~mzt + strain_id)
dds <- dds[ rowSums(counts(dds)) > 50, ] 
dds_pre <- DESeq(dds)
res_pre <- results(dds_pre, name = "mzt_zygotic_vs_maternal")
res_pre_tidy <- results(dds_pre, name = "mzt_zygotic_vs_maternal", tidy = TRUE)
```

```{r}
pre_plot_dat <- res_pre_tidy %>% 
  as_tibble() %>% 
  mutate(sig = ifelse(padj < 0.05 & log2FoldChange > 0, "Up", 
                      ifelse(padj < 0.05 & log2FoldChange < 0, "Down", "Not Sig")))

pre_plot_dat <-  pre_plot_dat %>% filter(!is.na(sig))

n_sig_up <- nrow(dplyr::filter(pre_plot_dat, sig == "Up")) %>% 
  formatC(big.mark = ",")
n_sig_down <- nrow(dplyr::filter(pre_plot_dat, sig == "Down"))  %>% 
  formatC(big.mark = ",")
n_notsig <- nrow(dplyr::filter(pre_plot_dat, sig == "Not Sig"))  %>% 
  formatC(big.mark = ",")

pre_plot <- ggplot(pre_plot_dat, 
       aes(baseMean, log2FoldChange)) +
  geom_point(aes(colour = sig), size = 0.1) +
  scale_colour_viridis(discrete = TRUE,
                       name = "",
                       labels = c(paste0("Significantly decreased (n = ", n_sig_down, ")"),
                                  paste0("Not Significant (n= ", n_notsig, ")"),
                                  paste0("Significantly increased (n = ", n_sig_up, ")"))) +
  scale_x_log10() + 
  labs(x = expression(paste("log"[10], " Average Expression")),
       y = expression(paste("log"[2], " ", frac("Zygotic", "Maternal"))),
       title = "pre-mRNA") +
  guides(colour = guide_legend(nrow = 3,
                               override.aes = list(size = 3))) +
  theme(legend.position = "top")
  
pre_plot


mature_plot_dat <- res_mature_tidy %>% 
  as_tibble() %>% 
  mutate(sig = ifelse(padj < 0.05 & log2FoldChange > 0, "Up", 
                      ifelse(padj < 0.05 & log2FoldChange < 0, "Down", "Not Sig")))
mature_plot_dat <-  mature_plot_dat %>% filter(!is.na(sig))

n_sig_up <- nrow(dplyr::filter(mature_plot_dat, sig == "Up")) %>% 
  formatC(big.mark = ",")
n_sig_down <- nrow(dplyr::filter(mature_plot_dat, sig == "Down"))  %>% 
  formatC(big.mark = ",")
n_notsig <- nrow(dplyr::filter(mature_plot_dat, sig == "Not Sig"))  %>% 
  formatC(big.mark = ",")

 
mat_plot <- ggplot(mature_plot_dat, 
       aes(baseMean, log2FoldChange)) +
  geom_point(aes(colour = sig), size = 0.1) +
  scale_colour_viridis(discrete = TRUE,
                       name = "",
                       labels = c(paste0("Significantly decreased (n = ", n_sig_down, ")"),
                                  paste0("Not Significant (n= ", n_notsig, ")"),
                                  paste0("Significantly increased (n = ", n_sig_up, ")"))) +
  scale_x_log10() + 
  labs(x = expression(paste("log"[10], " Average Expression")),
       y = expression(paste("log"[2], " ", frac("Zygotic", "Maternal"))),
       title = "mature-mRNA") +
  guides(colour = guide_legend(nrow = 3, 
                               override.aes = list(size = 3))) +
  theme(legend.position = "top")
  
plt <- plot_grid(pre_plot, mat_plot, nrow = 1)
save_plot("deseq_pre_mat_results.pdf", plt, nrow = 1, ncol = 2)
```


## Overlap between zygotic transcripts 

How similar are the significant transcripts recovered based on exonic or intronic signal?

```{r plot_zyg_mat_pre}
library(eulerr)

sig_mat_up <- res_mature_tidy %>% filter(padj < 0.05, log2FoldChange > 0)
sig_pre_up <- res_pre_tidy %>% filter(padj < 0.05, log2FoldChange > 0)
all_sig_up <- union(sig_mat_up$row, sig_pre_up$row)
lgl_up_df <- data.frame(
  `mature_mRNA` =  all_sig_up %in% sig_mat_up$row,
  `pre_mRNA` =  all_sig_up %in% sig_pre_up$row
)

sig_mat_down <- res_mature_tidy %>% filter(padj < 0.05, log2FoldChange < 0)
sig_pre_down <- res_pre_tidy %>% filter(padj < 0.05, log2FoldChange < 0)
all_sig_down <- union(sig_mat_down$row, sig_pre_down$row)
lgl_down_df <- data.frame(
  `mature_mRNA` =  all_sig_down %in% sig_mat_down$row,
  `pre_mRNA` =  all_sig_down %in% sig_pre_down$row
)

fit_up <- euler(lgl_up_df)
fit_down <- euler(lgl_down_df)

plot(fit_up, fill = viridis(2), quantities = TRUE, main = "Increased abundance in Zygotic Stages")
plot(fit_down, fill = viridis(2), quantities = TRUE, main = "Decreased abundance in Zygotic Stages")
```


What are the transcripts that have increased intronic epression, but no increases in mature?

### Genes with pre-mRNA increases and no increases in mature 

```{r hmap_intronic_only, fig.height = 14, fig.width = 8}
interest_txs <- sig_pre_up[!sig_pre_up$row %in% sig_mat_up$row, ]

dds_pre_rlogs <- rlog(dds_pre, blind = F)

# add in colnames
cols <- pdata %>% 
  mutate(cnames = str_c(developmental_stage, strain , sep = "::")) %>% 
  pull(cnames)

rlog_counts_pre <- assay(dds_pre_rlogs)
colnames(rlog_counts_pre) <- cols

dds_mat_rlogs <- rlog(dds_mature, blind = F)

# add in colnames
cols <- pdata %>% 
  mutate(cnames = str_c(developmental_stage, strain , sep = "::")) %>% 
  pull(cnames)

rlog_counts_mat <- assay(dds_mat_rlogs)
colnames(rlog_counts_mat) <- cols

common_genes <- intersect(rownames(rlog_counts_pre),rownames(rlog_counts_mat))
rlog_counts_pre <- rlog_counts_pre[common_genes, ]
rlog_counts_mat <- rlog_counts_mat[common_genes, ]
 
sig_pre_rlogs <- rlog_counts_pre[rownames(rlog_counts_pre) %in% interest_txs$row, ]
sig_mat_rlogs <- rlog_counts_mat[rownames(rlog_counts_mat) %in% interest_txs$row, ]

ht1 <- Heatmap(sig_pre_rlogs, 
         name = "pre-mRNA abundance\nrlog",
         show_row_names = F,
         show_row_dend = F)

ht2 <- Heatmap(sig_mat_rlogs, 
         name = "mature-mRNA abundance\nrlog",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         column_order = column_order(ht1))

draw(ht1 + ht2, column_title = "Increased pre-mRNA \nnot Increased mature")

```


### Genes with pre-mRNA increases and no change in mature (up or down)

```{r, fig.height = 14, fig.width = 8}

notsig_mat <- res_mature_tidy %>% filter(padj >= 0.05 | is.na(padj))
interest_txs_nosig_mature <- sig_pre_up[sig_pre_up$row %in% notsig_mat$row, ]

sig_pre_rlogs <- rlog_counts_pre[rownames(rlog_counts_pre) %in% interest_txs_nosig_mature$row, ]
sig_mat_rlogs <- rlog_counts_mat[rownames(rlog_counts_mat) %in% interest_txs_nosig_mature$row, ]

ht1 <- Heatmap(sig_pre_rlogs, 
         name = "pre-mRNA abundance\nrlog",
         show_row_names = F,
         show_row_dend = F)

ht2 <- Heatmap(sig_mat_rlogs, 
         name = "mature-mRNA abundance\nrlog",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         column_order = column_order(ht1))

draw(ht1 + ht2, column_title = "Increased pre-mRNA \nnot significant mature")
```

### Genes with pre-mRNA increases and decreases in mature 
```{r, fig.height = 14, fig.width = 8}
## not sig in mature (neither up or down)
interest_txs_down_mature <- sig_pre_up[sig_pre_up$row %in% sig_mat_down$row, ]

sig_pre_rlogs <- rlog_counts_pre[rownames(rlog_counts_pre) %in% interest_txs_down_mature$row, ]
sig_mat_rlogs <- rlog_counts_mat[rownames(rlog_counts_mat) %in% interest_txs_down_mature$row, ]

ht1 <- Heatmap(sig_pre_rlogs, 
         name = "pre-mRNA abundance\nrlog",
         show_row_names = F,
         show_row_dend = F)

ht2 <- Heatmap(sig_mat_rlogs, 
         name = "mature-mRNA abundance\nrlog",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         column_order = column_order(ht1))

draw(ht1 + ht2, column_title = "Increased pre-mRNA \n Decreased mature")

```





### Output tables

The interesting transcripts that have increased intronic expression but do not have increased mature levels will be written to tables to send to Olivia.

```{r outtbls}

gene2name <- dplyr::select(gtf, gene_id, gene_name) %>% unique()

res_mature_tidy_simple <- left_join(res_mature_tidy, 
                             gene2name, 
                             by = c("row" = "gene_id")) %>% 
  dplyr::select(gene_name, gene_id = row, baseMean:log2FoldChange, padj)

res_pre_tidy_simple <- left_join(res_pre_tidy, 
                             gene2name, 
                             by = c("row" = "gene_id")) %>% 
  dplyr::select(gene_name, gene_id = row, baseMean:log2FoldChange, padj)

all_gene_measurements <- full_join(res_pre_tidy_simple, res_mature_tidy_simple,
                                   by = c("gene_id", "gene_name"), 
                                   suffix = c("_pre-mRNA", "_mature-mRNA"))

uppre_not_upmat <- all_gene_measurements %>% 
  filter(gene_id %in% interest_txs$row) %>% 
  arrange(`padj_pre-mRNA`) 

uppre_notsig_mat <- uppre_not_upmat %>% 
  filter(`padj_mature-mRNA` >= 0.05 | is.na(`padj_mature-mRNA`)) %>% 
  arrange(`padj_pre-mRNA`) 

uppre_sig_downmat <- uppre_not_upmat %>% 
  filter(`padj_mature-mRNA` < 0.05, `log2FoldChange_mature-mRNA` < 0) %>% 
  arrange(`padj_pre-mRNA`) 

today <- Sys.Date()

readme <- c(
  "filename\tdescription",
  "upregulated_intronic_not_upregulated_mature\tgenes with increased premRNA (padj < 0.05) and not significantly increased mature (padj >= 0.05 for log2foldchange > 0 or log2foldchange < 0 and any padj value)",
  "upregulated_intronic_not_changed_mature\tgenes with increased premRNA (padj < 0.05) and not significant mature (padj >= 0.05)",
  "upregulated_intronic_downregulated_mature\tgenes with increased premRNA (padj < 0.05) and decreased mature (padj < 0.05 and log2foldchange < 0)",
  "all_genes\tmeasurements for all genes"
)

write_lines(readme, "README.txt")

write_tsv(uppre_not_upmat, paste0("upregulated_intronic_not_upregulated_mature_", today, ".tsv"))
write_tsv(uppre_notsig_mat, paste0("upregulated_intronic_not_changed_mature_", today, ".tsv"))
write_tsv(uppre_sig_downmat, paste0("upregulated_intronic_downregulated_mature_", today, ".tsv"))
write_tsv(all_gene_measurements, paste0("all_genes_", today, ".tsv"))
```


## Compare to SNP data called by Michael Eisen's group

```{r classify_txs, eval = T}

detected_genes <- all_gene_measurements %>% 
  filter(!is.na(`padj_mature-mRNA`))

mature_counts <- matures$counts
col_info <- colData(dds_mature) %>% 
  as_data_frame() %>% 
  mutate(id = str_c(developmental_stage, "::", strain)) %>% 
  mutate(stage_classifier = ifelse(str_detect(developmental_stage, "oocyte|egg"),
                                   "oocyte",
                                   "zygote"))

colnames(mature_counts) <- col_info$id

maternal_samples <- filter(col_info, stage_classifier == "oocyte") %>% pull("id")
zygotic_sammples <- filter(col_info, mzt == "zygotic") %>% pull("id")

## select transcripts with at least 10 reads from 3 or more maternal samples (only egg or oocyte)
maternally_expressed <- rowSums(mature_counts[, maternal_samples] > 10) > 2
maternally_expressed <- mature_counts[maternally_expressed, maternal_samples]

## find zygotically transcribed transcripts (up in either pre or mature mRNA)
zygotically_transcribed <- filter(detected_genes,
                                  (`padj_pre-mRNA` < 0.05 & detected_genes$`log2FoldChange_pre-mRNA` > 0) |
                                  (`padj_mature-mRNA` < 0.05 & detected_genes$`log2FoldChange_mature-mRNA` > 0))

maternal_and_zygotic <- intersect(rownames(maternally_expressed), 
                                  zygotically_transcribed$gene_id)

zygotic_only <- setdiff(zygotically_transcribed$gene_id,
                        rownames(maternally_expressed))
                        
maternal_only <- setdiff(rownames(maternally_expressed),
                         zygotically_transcribed$gene_id)

classifications <- lst(maternal_only,
      zygotic_only,
      maternal_and_zygotic)


lens <- map_int(classifications, length)

data_frame(type = names(classifications),
           n_genes = lens)

# Note that monoexonic genes must have increased mature mRNA levels in zygotes to be called zygotic.
classifications <- bind_rows(map(classifications, ~data_frame(gene_id = .x)), .id = "type")

detected_genes <- left_join(detected_genes, 
                            classifications,
                            by = "gene_id")
```

"Overall, 5,598 genes were classified as maternal, 2,210 as zygotic, and 1,195 and maternal+zygotic (the classification for each gene is listed in Dataset S1)."

```{r}
edata <- read_tsv("https://ndownloader.figshare.com/files/400050")

res_eisen <- edata %>% 
  dplyr::select(NAME, CLASS) %>% 
  left_join(detected_genes, ., 
            by = c("gene_name" = "NAME"),
            suffixe) %>% 
  dplyr::rename(kr_class = type,
                eisen_class = CLASS)

summary_dat <- res_eisen %>% 
 group_by(kr_class, eisen_class) %>% 
 summarize(n())

summary_dat 

res_eisen <- res_eisen %>% 
  mutate(eisen_class = ifelse(is.na(eisen_class),
                              "not classified",
                              eisen_class),
         kr_class = ifelse(is.na(kr_class),
                                 "not classified",
                                 kr_class),
         kr_class = factor(kr_class,
                           levels = c(
                             "maternal_only",
                             "maternal_and_zygotic",
                             "zygotic_only",
                             "not classified"
                           )))


plt <- ggplot(res_eisen, aes(kr_class)) +
  geom_bar(aes(fill = eisen_class)) +
  labs(y = "# of genes", x = "intron based classification") +
  scale_fill_brewer(palette = "Set1", 
                    name = "SNP based\nclassification\n(Lott et al 2011)") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

plt

save_plot("eisen_vs_intron_classification.pdf", plt)


write_tsv(res_eisen, "eisen_vs_intron_classification.tsv")

res_eisen <- read_tsv("eisen_vs_intron_classification.tsv")
```

## Kmeans classification

### Normalized counts
```{r prepare_for_kmeans}
library(flexclust) #kmeans++

mature_counts_lrt <- log2(counts(dds_mature, normalized =T) + 1)
pre_counts_lrt <- log2(counts(dds_pre, normalized = T) + 1)

colnames(mature_counts_lrt) <- as_data_frame(colData(dds_mature)) %>% 
  mutate(id = str_c(developmental_stage, "::", strain)) %>% pull(id)

colnames(pre_counts_lrt) <- as_data_frame(colData(dds_pre)) %>% 
  mutate(id = str_c(developmental_stage, "::", strain)) %>% pull(id)

mature_zscores <- t(scale(t(mature_counts_lrt)))
pre_zscores <- t(scale(t(pre_counts_lrt)))

sig_pre <- res_pre_tidy[res_pre_tidy$padj < 0.05, ]
sig_mat <- res_mature_tidy[res_mature_tidy$padj < 0.05, ]

sig_pre_zscores <- pre_zscores[rownames(pre_zscores) %in% sig_pre$row, ]
sig_mature_zscores <- mature_zscores[rownames(mature_zscores) %in% sig_mat$row, ] 

mydata <- sig_pre_zscores
wss <- (nrow(mydata)-1) * sum(apply(mydata,2,var))
for (i in 2:15) {
  wss[i] <- sum(kmeans(mydata, centers=i)$withinss)
}
dat <- data_frame(Within_sum_of_squares = wss,
                  n_cluster = seq_along(1:length(wss)))

ggplot(dat,
       aes(n_cluster, Within_sum_of_squares)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks = pretty(dat$n_cluster, n = 10))

```


```{r hmaps, fig.width = 10, fig.height = 14}

set.seed(20180430)
pre_km <- flexclust::kcca(sig_pre_zscores, k = 5, 
                        control = list(initcent = "kmeanspp"))
set.seed(20180430)
mat_km <- flexclust::kcca(sig_mature_zscores, k = 5, 
                        control = list(initcent = "kmeanspp"))


time_order <- c(
  "Stage 11 oocyte::wt",
  "Stage 12 oocyte::wt",
  "Stage 13 oocyte::wt",
  "Stage 14 oocyte::wt",
  "Activated egg::wt",
  "0-1 hr embryo::wt",
  "0-1 hr embryo::w1118",
  "0-1 hr embryo::eGFP-ME31B",
  "1-2 hr embryo::w1118",
  "1-2 hr embryo::eGFP-ME31B",  
  "2-3 hr embryo::wt",
  "2-3 hr embryo::w1118",
  "2-3 hr embryo::eGFP-ME31B",  
  "3-4 hr embryo::wt",
  "3-4 hr embryo::w1118",
  "3-4 hr embryo::eGFP-ME31B",
  "4-5 hr embryo::w1118",
  "4-5 hr embryo::eGFP-ME31B",
  "5-6 hr embryo::wt"
)

sig_pre_zscores <- sig_pre_zscores[, time_order]
sig_mature_zscores <- sig_mature_zscores[, time_order]

ht1 <- Heatmap(sig_pre_zscores,
         name = "pre-mRNA\nabundance\nzscore",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         split = pre_km@cluster,
         km_title = "%i")

pdf("fly_premRNA_kmeans.pdf", width = 5)
print(ht1)
dev.off()


common_genes <- intersect(rownames(sig_pre_zscores), rownames(mature_zscores))
ht1_1 <- Heatmap(sig_pre_zscores[common_genes, ],
         name = "pre-mRNA\nabundance\nzscore",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         split = pre_km@cluster[common_genes],
         km_title = "%i")

ht1_2 <- Heatmap(mature_zscores[common_genes, ],
         name = "mature-mRNA\nabundance\nzscore",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         column_order = column_order(ht1))

pdf("fly_pre_mRNA_kmeans_with_mat.pdf", width = 8)
  print(ht1_1 + ht1_2)
dev.off()

ht2 <- Heatmap(sig_mature_zscores, 
         name = "mature-mRNA abundance\nzscore",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         split = mat_km@cluster,
         km_title = "%i")
ht2

pdf("fly_mat_mRNA_kmeans.pdf", width = 8)
print(ht2)
dev.off()

combined_premat_zscores <- cbind(sig_pre_zscores[common_genes, ], 
                                 mature_zscores[common_genes, colnames(sig_pre_zscores)])
                       
new_cols <- c(paste0("pre_",
                     colnames(combined_premat_zscores)[1:ncol(sig_pre_zscores)]),
              paste0("mature_",
                     colnames(combined_premat_zscores)[(ncol(sig_pre_zscores) + 1): ncol(combined_premat_zscores)]))

colnames(combined_premat_zscores) <- new_cols

ht1_1 <- Heatmap(combined_premat_zscores,
         name = "abundance\nzscore",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         split = pre_km@cluster[common_genes],
         km_title = "%i")

pdf("pre_mRNA_kmeans_with_mature_clustered.pdf", width = 10, height = 12)
draw(ht1_1,  padding = unit(c(15, 2, 2, 2), "mm"))
dev.off()



shared <- intersect(interest_txs$row, rownames(combined_premat_zscores))

ht1_1 <- Heatmap(combined_premat_zscores[shared, ],
         name = "abundance\nzscore",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         split = pre_km@cluster[shared],
         km_title = "%i")

pdf("pre_mRNA_kmeans_with_mature_clustered_no_mature_increase.pdf", width = 10, height = 12)
draw(ht1_1,  padding = unit(c(15, 2, 2, 2), "mm"))
dev.off()


sig_pre_rlogs <- rlog_counts_pre[rownames(rlog_counts_pre) %in% interest_txs$row, 
                                 time_order]
sig_mat_rlogs <- rlog_counts_mat[rownames(rlog_counts_mat) %in% interest_txs$row, 
                                 time_order]
ht1 <- Heatmap(sig_pre_rlogs, 
         name = "pre-mRNA\nrlog",
         show_row_names = F,
         show_row_dend = F,
         show_column_dend = F,
         cluster_columns = F,
         split = pre_km@cluster[rownames(sig_pre_rlogs)])

ht2 <- Heatmap(sig_mat_rlogs, 
         name = "mature-mRNA\nrlog",
         show_row_names = F,
         show_row_dend = F,
         show_column_dend = F,
         cluster_columns = F,
         column_order = column_order(ht1))

draw(ht1 + ht2, column_title = "Increased pre-mRNA \nnot Increased mature")

pdf("pre_mRNA_increases_no_increase_mature_log.pdf", width = 6.5)
draw(ht1 + ht2)
dev.off()
```


### Rlogs

```{r hmaps_rlogs, fig.width = 10, fig.height = 14, eval = F}

sig_pre_rlogs <- rlog_counts_pre[rownames(rlog_counts_pre) %in% sig_pre$row, ]
sig_mature_rlogs <- rlog_counts_mat[rownames(rlog_counts_mat) %in% sig_mat$row, ] 


set.seed(20180430)
pre_km <- flexclust::kcca(sig_pre_rlogs, k = 5, 
                        control = list(initcent = "kmeanspp"))
set.seed(20180430)
mat_km <- flexclust::kcca(sig_mature_rlogs, k = 5, 
                        control = list(initcent = "kmeanspp"))


time_order <- c(
  "Stage 11 oocyte::wt",
  "Stage 12 oocyte::wt",
  "Stage 13 oocyte::wt",
  "Stage 14 oocyte::wt",
  "Activated egg::wt",
  "0-1 hr embryo::wt",
  "0-1 hr embryo::w1118",
  "0-1 hr embryo::eGFP-ME31B",
  "1-2 hr embryo::w1118",
  "1-2 hr embryo::eGFP-ME31B",  
  "2-3 hr embryo::wt",
  "2-3 hr embryo::w1118",
  "2-3 hr embryo::eGFP-ME31B",  
  "3-4 hr embryo::wt",
  "3-4 hr embryo::w1118",
  "3-4 hr embryo::eGFP-ME31B",
  "4-5 hr embryo::w1118",
  "4-5 hr embryo::eGFP-ME31B",
  "5-6 hr embryo::wt"
)

sig_pre_rlogs <- sig_pre_rlogs[, time_order]
sig_mat_rlogs <- sig_mat_rlogs[, time_order]

ht1 <- Heatmap(sig_pre_rlogs,
         name = "pre-mRNA\nabundance\nrlog",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         split = pre_km@cluster,
         km_title = "%i")

pdf("fly_premRNA_kmeans_rlog.pdf", width = 8)
print(ht1)
dev.off()


common_genes <- intersect(rownames(sig_pre_rlogs), rownames(rlog_counts_mat))
ht1_1 <- Heatmap(sig_pre_rlogs[common_genes, ],
         name = "pre-mRNA\nabundance\nrlog",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         split = pre_km@cluster[common_genes],
         km_title = "%i")

ht1_2 <- Heatmap(rlog_counts_mat[common_genes, ],
         name = "mature-mRNA\nabundance\nrlog",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         column_order = column_order(ht1))

pdf("fly_pre_mRNA_kmeans_with_mat_rlog.pdf", width = 8)
  print(ht1_1 + ht1_2)
dev.off()

ht2 <- Heatmap(sig_mat_rlogs, 
         name = "mature-mRNA abundance\nrlog",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         split = mat_km@cluster,
         km_title = "%i")
ht2

pdf("fly_mat_mRNA_kmeans_rlog.pdf", width = 8)
print(ht2)
dev.off()

combined_premat_rlogs <- cbind(sig_pre_rlogs[common_genes, ],
                                 rlog_counts_mat[common_genes, ])
                       
new_cols <- c(paste0("pre_",
                     colnames(combined_premat_rlogs)[1:ncol(sig_pre_rlogs)]),
              paste0("mature_",
                     colnames(combined_premat_rlogs)[(ncol(sig_pre_rlogs) + 1): ncol(combined_premat_rlogs)]))

colnames(combined_premat_rlogs) <- new_cols

ht1_1 <- Heatmap(combined_premat_rlogs,
         name = "abundance\nzscore",
         show_row_names = F,
         show_row_dend = F,
         cluster_columns = F,
         split = pre_km@cluster[common_genes],
         km_title = "%i")

pdf("pre_mRNA_kmeans_with_mature_clustered_rlogs.pdf", width = 10, height = 12)
draw(ht1_1,  padding = unit(c(15, 2, 2, 2), "mm"))
dev.off()
```


## plot average profile per cluster

```{r avg_prof}
clust_ids <- pre_km@cluster

avg_profile <- sig_pre_zscores %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  left_join(., data_frame(gene_id = names(clust_ids),
                          cluster = clust_ids), by = "gene_id") %>% 
  gather(sample, zscore, -cluster, -gene_id) %>% 
  mutate(time = str_split(sample, "::", simplify = T) %>% .[, 1],
         cluster = as.character(cluster)) %>% 
  group_by(cluster) %>% 
  mutate(n_transcripts = length(unique(gene_id))) %>% 
  group_by(cluster, time, n_transcripts) %>% 
  summarize(med_zscore = median(zscore)) %>% 
  ungroup() %>% 
  mutate(time = factor(time, 
                       levels = c("Stage 11 oocyte",
                                  "Stage 12 oocyte",
                                  "Stage 13 oocyte",
                                  "Stage 14 oocyte",
                                  "Activated egg",
                                  "0-1 hr embryo",
                                  "1-2 hr embryo",
                                  "2-3 hr embryo",
                                  "3-4 hr embryo",
                                  "4-5 hr embryo",
                                  "5-6 hr embryo")),
         cluster = str_c(cluster, " (", formatC(n_transcripts, big.mark = ","), ")"))
  
plt <- ggplot(avg_profile, aes(time, med_zscore)) +
  geom_line(aes(group = cluster, colour = cluster),
            size = 1.5) +
  scale_color_brewer(palette = "Paired") + 
  labs(y = "Expression profile\n(median of z-scores)", x = "") + 
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.5))

save_plot("premRNA_expression_per_cluster.pdf", plt, base_width = 5.5)
```

```{r mat_avg_prof}
clust_ids <- mat_km@cluster

avg_profile <- sig_mature_zscores %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  left_join(., data_frame(gene_id = names(clust_ids),
                          cluster = clust_ids), by = "gene_id") %>% 
  gather(sample, zscore, -cluster, -gene_id) %>% 
  mutate(time = str_split(sample, "::", simplify = T) %>% .[, 1],
         cluster = as.character(cluster)) %>% 
  group_by(cluster) %>% 
  mutate(n_transcripts = length(unique(gene_id))) %>% 
  group_by(cluster, time, n_transcripts) %>% 
  summarize(med_zscore = median(zscore)) %>% 
  ungroup() %>% 
  mutate(time = factor(time, 
                       levels = c("Stage 11 oocyte",
                                  "Stage 12 oocyte",
                                  "Stage 13 oocyte",
                                  "Stage 14 oocyte",
                                  "Activated egg",
                                  "0-1 hr embryo",
                                  "1-2 hr embryo",
                                  "2-3 hr embryo",
                                  "3-4 hr embryo",
                                  "4-5 hr embryo",
                                  "5-6 hr embryo")),
         cluster = str_c(cluster, " (", formatC(n_transcripts, big.mark = ","), ")"))
  
plt <- ggplot(avg_profile, aes(time, med_zscore)) +
  geom_line(aes(group = cluster, colour = cluster),
            size = 1.5) +
  scale_color_brewer(palette = "Paired") + 
  labs(y = "Expression profile\n(median of z-scores)", x = "") + 
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.5))

save_plot("matmRNA_expression_per_cluster.pdf", plt, base_width = 5.5)
```



### increased pre-mRNA not increased mature

```{r}
clust_ids <- pre_km@cluster

avg_profile_pre <- pre_counts_lrt[shared, ] %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  gather(sample, zscore, -gene_id) %>% 
  mutate(time = str_split(sample, "::", simplify = T) %>% .[, 1]) %>% 
  group_by(time) %>% 
  summarize(med_zscore = median(zscore)) %>% 
  ungroup() %>% 
  mutate(time = factor(time, 
                       levels = c("Stage 11 oocyte",
                                  "Stage 12 oocyte",
                                  "Stage 13 oocyte",
                                  "Stage 14 oocyte",
                                  "Activated egg",
                                  "0-1 hr embryo",
                                  "1-2 hr embryo",
                                  "2-3 hr embryo",
                                  "3-4 hr embryo",
                                  "4-5 hr embryo",
                                  "5-6 hr embryo")))
  

avg_profile_mature <- mature_counts_lrt[shared, ] %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  gather(sample, zscore, -gene_id) %>% 
  mutate(time = str_split(sample, "::", simplify = T) %>% .[, 1]) %>% 
  group_by(time) %>% 
  summarize(med_zscore = median(zscore)) %>% 
  ungroup() %>% 
  mutate(time = factor(time, 
                       levels = c("Stage 11 oocyte",
                                  "Stage 12 oocyte",
                                  "Stage 13 oocyte",
                                  "Stage 14 oocyte",
                                  "Activated egg",
                                  "0-1 hr embryo",
                                  "1-2 hr embryo",
                                  "2-3 hr embryo",
                                  "3-4 hr embryo",
                                  "4-5 hr embryo",
                                  "5-6 hr embryo")))

avg_profile <- bind_rows(`pre-mRNA` = avg_profile_pre,
                         `mature-mRNA` = avg_profile_mature,
                         .id = "cluster")

plt <- ggplot(avg_profile, aes(time, med_zscore)) +
  geom_line(aes(group = cluster, colour = cluster),
            size = 1.5) +
  scale_color_brewer(palette = "Paired", name = "") + 
  labs(y = "Expression profile\n(median of log expression)", x = "") + 
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.5),
        legend.position = "top")

save_plot("premRNA_expression_no_mature_change_logexpr.pdf", plt, base_width = 4)

avg_profile_pre <- sig_pre_zscores[shared, ] %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  gather(sample, zscore, -gene_id) %>% 
  mutate(time = str_split(sample, "::", simplify = T) %>% .[, 1]) %>% 
  group_by(time) %>% 
  summarize(med_zscore = median(zscore)) %>% 
  ungroup() %>% 
  mutate(time = factor(time, 
                       levels = c("Stage 11 oocyte",
                                  "Stage 12 oocyte",
                                  "Stage 13 oocyte",
                                  "Stage 14 oocyte",
                                  "Activated egg",
                                  "0-1 hr embryo",
                                  "1-2 hr embryo",
                                  "2-3 hr embryo",
                                  "3-4 hr embryo",
                                  "4-5 hr embryo",
                                  "5-6 hr embryo")))
  

avg_profile_mature <- mature_zscores[shared, ] %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  gather(sample, zscore, -gene_id) %>% 
  mutate(time = str_split(sample, "::", simplify = T) %>% .[, 1]) %>% 
  group_by(time) %>% 
  summarize(med_zscore = median(zscore)) %>% 
  ungroup() %>% 
  mutate(time = factor(time, 
                       levels = c("Stage 11 oocyte",
                                  "Stage 12 oocyte",
                                  "Stage 13 oocyte",
                                  "Stage 14 oocyte",
                                  "Activated egg",
                                  "0-1 hr embryo",
                                  "1-2 hr embryo",
                                  "2-3 hr embryo",
                                  "3-4 hr embryo",
                                  "4-5 hr embryo",
                                  "5-6 hr embryo")))

avg_profile <- bind_rows(`pre-mRNA` = avg_profile_pre,
                         `mature-mRNA` = avg_profile_mature,
                         .id = "cluster")

plt <- ggplot(avg_profile, aes(time, med_zscore)) +
  geom_line(aes(group = cluster, colour = cluster),
            size = 1.5) +
  scale_color_brewer(palette = "Paired", name = "") + 
  labs(y = "Expression profile\n(median of z-scores)", x = "") + 
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.5))

save_plot("premRNA_expression_no_mature_change_zscores.pdf", plt, base_width = 5.5)
```


## write out clusters
```{r out_Clusters}
tx2gene_name <- gtf %>% 
  filter(type == "gene") %>% 
  dplyr::select(gene_name, gene_id) %>% 
  unique()

pre_clusters <- data_frame(gene_id = names(pre_km@cluster),
                           cluster = pre_km@cluster)
mat_clusters <- data_frame(gene_id = names(mat_km@cluster),
                           cluster = mat_km@cluster)

pre_clusters <- left_join(pre_clusters, tx2gene_name, by = "gene_id")
mat_clusters <- left_join(mat_clusters, tx2gene_name, by = "gene_id")

write_tsv(pre_clusters, "fly_pre_km_clusters.tsv")
write_tsv(mat_clusters, "fly_mat_km_clusters.tsv")

interest_txs <- left_join(interest_txs, gene2name, by = c("row" = "gene_id"))
write_tsv(interest_txs, "up_pre_not_up_mature.tsv")

write.table(mature_counts_lrt, "fly_mature_norm_counts.tsv", sep = "\t", quote = F)
write.table(pre_counts_lrt, "fly_pre_norm_counts.tsv", sep = "\t", quote = F)

```


