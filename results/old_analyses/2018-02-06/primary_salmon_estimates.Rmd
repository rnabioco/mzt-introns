---
title: "Examine intronic signals during MZT in Drosophila embryos"
author: "Kent Riemondy RBI"
date: '`r Sys.Date()`'
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

## Background

The Maternal to Zygotic Transistion (MZT) is a developmental stage in which the embryo initiates transcription of mRNAs from the zygotic genome. Maternally deposited mRNAs begin to be degraded and are replaced by zygotic messages. 

Zygotic mRNAs can be distinguished from maternal mRNAs, due to the presence or higher proportions of introns. Maternally derived mRNAs are likely to be spliced, and any remaining intron lariat degraded prior to fertilization. In contrast zygotic transcription will produce mRNAs in that need to be spliced, and thus there will be some proportion of unspliced mRNA, and intron lariat derivied from the zygotic transcripts. 

Using ribo-zero depleted total-RNA-Seq libraries, one would expect to be able to recover intronic mRNA fragements, and be able to assign for each transcript, the relative proportion of each transcript that is maternally or zygotically derived. 


## Approach

Each total RNA-Seq lib was trimmed to remove Tru-Seq adapters (Rissland libraries), or barcodes and custom 3' adapter (Bartel libraries). The trimmed reads were then processed with `salmon` to estimate `TPMs` for each transcript. The `salmon` transcript database was modified to include a pre-mRNA entry, which was designated as an exon that spanned the entire gene. This pre-mRNA annotation matches the `gene` entry from the annotaiton file. By including the pre-mRNA transcript in the `salmon` database, one can get an estimate of the fraction of pre-mRNA or mature mRNA present in each sample. 

First we'll examine the extent to which pre-mRNA transcripts increase during embryonic development. Then, if a clear increase is present, we can classify transcripts into a % maternal and % zygotic, and additional classify the temporal pattern of zygotic transcription i.e. are there distinct sets of early versus late transcripts, and do their transcriptional pattern suggest function (TF transcription prior to target activation/repression, miRNA transcription before target repression, RBP transcription prior to translational control, etc.)

 
## RNA-Seq Libraries
```{r load_libs}
source("../../R/globals.r")
```



```{r get_metadata}
mdata1 <- read_tsv(file.path(data_dir, "raw_data", "GSE83616_run_info_geo.txt"))
mdata2 <- read_tsv(file.path(data_dir, "raw_data", "GSE98106_run_info_geo.txt"))


#simplify mdata
mdata1 <- dplyr::select(mdata1,
                       Run_s, 
                       developmental_stage_s,
                       genotype_s,
                       source_name_s,
                       Assay_Type_s)

#simplify mdata
mdata2 <- dplyr::select(mdata2,
                       Run_s, 
                       developmental_stage_s,
                       rip_antibody_s,
                       source_name_s,
                       strain_s)

# select relevant libs
mdata2 <- dplyr::filter(mdata2,
                     source_name_s == "Embryo",
                     strain_s %in% c("w1118", "eGFP-ME31B"),
                     rip_antibody_s == "none") %>% 
  dplyr::select(-rip_antibody_s)

mdata1 <- dplyr::filter(mdata1,
                     genotype_s == "wt",
                     Assay_Type_s == "RNA-Seq") %>% 
  dplyr::select(-Assay_Type_s) %>% 
  dplyr::rename(strain_s = genotype_s)


mdata <- list(mdata1, mdata2)
names(mdata) <- c("eichhorn", "rissland")

mdata <- bind_rows(mdata, .id = "study")
#cleanup names
mdata <- mdata %>% 
  mutate(source_name_s = ifelse(source_name_s == "embryos", 
                                "Embryo",
                                source_name_s),
         developmental_stage_s = str_replace(developmental_stage_s,
                                             " h ",
                                             " hr "))

# cleanup colnames
colnames(mdata) <- str_replace(colnames(mdata),
                               "_s$",
                               "")

mdata
```


## Alignment %


```{r alignment}

alignment <- map(mdata$Run, 
                  ~fromJSON(txt = file.path(data_dir, 
                          "salmon", 
                          .x, 
                          "aux_info", 
                          "meta_info.json")) %>% .$percent_mapped)

alignment <- data_frame(library = mdata$Run,
                        percent_mapped = unlist(alignment))


inner_join(alignment, 
          mdata, 
          by = c("library" = "Run"))
```

## Load in salmon data

```{r load_dat, message = F}
files <- dir(file.path(data_dir, "salmon"),
            recursive = T,
            pattern = "*quant.sf",
            full.names = T)

dat <- map(files, read_tsv)

# name with libraryID
names(dat) <- dirname(files) %>% 
  str_split(., "[/]", simplify = T) %>% 
  .[, 8]

dat <- bind_rows(dat, .id = "libraryID")

#join with main data
dat <- inner_join(dat, 
                 mdata,
                by = c("libraryID" = "Run"))
```

### transcript to gene mapping
```{r drop_monoexonic}
gtf <- "~/Projects/shared_dbases/annotation/drosophila/Drosophila_melanogaster.BDGP6.84.gtf"
gtf <- import(gtf)
gtf <- as.data.frame(gtf)

gtf_summary <- dplyr::filter(gtf, type == "exon") %>% 
  dplyr::select(seqnames, start, end, strand, gene_id) %>% 
  dplyr::rename(chrom = seqnames) %>% 
  unique() %>% 
  group_by(gene_id) %>% 
  bed_merge() %>% 
  dplyr::summarize(total_exons = n())

monoexonic_genes <- dplyr::filter(gtf_summary, total_exons == 1) %>% pull(gene_id)
```


```{r remove_monoexonic}

dat <- anti_join(dat, 
                    data_frame(gene_id = monoexonic_genes),
                 by = c("Name" = "gene_id"))

# classify transcripts as primary or mature
dat %>% 
  mutate(type = ifelse(str_detect(Name, 
                                  "^pre_"), 
                       "pre", "mature")) -> dat

# drop unneeded data
dat <- dplyr::select(dat,
                     -c(Length:EffectiveLength, 
                        NumReads))

gene2tx <- gtf[, c("gene_id", "transcript_id")]
gene2tx <- unique(gene2tx)
gene2tx <- na.omit(gene2tx)

# add in geneid attribute
dat <- left_join(dat, gene2tx, by = c("Name" = "transcript_id")) %>% 
  dplyr::rename(transcript_id = Name)

# add geneid attribute for pre_ annotations

dat <- mutate(dat, 
              gene_id = ifelse(type == "pre",
                               str_replace(transcript_id, "^pre_", ""),
                               gene_id))

dat <- mutate(dat,
              monoexonic = gene_id %in% monoexonic_genes)
```

### plot pre_mRNA ratio

```{r, calc_premRNA}
# sum primary and mature TPMs for each gene 
summary_dat <- dplyr::select(dat, TPM, gene_id, 
              libraryID, type, developmental_stage,
              study, strain) %>% 
  group_by(gene_id, libraryID, 
           developmental_stage, type,
           strain) %>% 
  dplyr::summarize(total_tpm = sum(TPM, na.rm = F)) %>% 
  ungroup() 

## calc primary ratio
tpm_summary <- summary_dat %>% 
  spread(type, total_tpm) %>% 
  mutate(primary_ratio  = pre / (mature + pre))


## calc mean primary ratio
tpm_means <- tpm_summary %>% 
  group_by(gene_id, 
           developmental_stage,
           strain) %>% 
  summarize(mean_primary = mean(primary_ratio,
                                na.rm = T)) 

tpm_means <- mutate(tpm_means, 
                       stage = factor(developmental_stage, 
                                         levels = c(
                                           "Stage 11 oocyte",
                                           "Stage 12 oocyte",
                                           "Stage 13 oocyte",
                                           "Stage 14 oocyte",
                                           "Activated egg",
                                           "0-1 hr embryo",
                                           "1-2 hr embryo",
                                           "2-3 hr embryo",
                                           "3-4 hr embryo",
                                           "4-5 hr embryo",
                                           "5-6 hr embryo")
                                         )
                       )

tpm_means <- mutate(tpm_means,
                       strain = ifelse(strain == "wt",
                                       paste(strain, 
                                             "(Eichhorn)"),
                                       paste(strain,
                                             "(Rissland)")))
                                        
p <- ggplot(tpm_means, 
       aes(stage, mean_primary)) +
  stat_boxplot(geom ='errorbar', 
               coef = 1e3) +
  geom_boxplot(aes(fill = stage, 
                   ymin=..lower.., 
                   ymax=..upper..),
               coef = 1e3) + 
  facet_grid(~strain, scale = "free") +
  labs(x = "",
       y = expression(frac("pre-mRNA TPM", 
                           "mature + pre-mRNA TPM"))) +
  scale_fill_viridis(discrete = T,
                    name = "Transcript Type",
                    breaks = c("pre", "mature"),
                    labels = c("pre-mRNA", "mature-mRNA")) +
  theme(
    axis.text.x = element_text(angle = 90,
                               vjust = 0.5,
                               hjust = 0.5),
    strip.text = element_text(size = 8)
  )

p
save_plot("premRNA_ratio.pdf", p, base_width = 6)

tpm_means %>% 
  group_by(gene_id, developmental_stage) %>% 
  summarize(mean_primary = mean(mean_primary, na.rm = T)) %>% 
  mutate(strain = "all strains") %>% 
  bind_rows(tpm_means, .) %>% 
  arrange(gene_id) -> all_combined

ggplot(all_combined, 
       aes(developmental_stage, mean_primary)) +
  geom_boxplot(aes(fill = developmental_stage), coef = 1e3) + 
  facet_grid(~strain, scale = "free") +
  labs(x = "",
       y = expression(frac("pre-mRNA TPM", 
                           "mature + pre-mRNA TPM"))) +
  scale_fill_brewer(palette = "Set1",
                    name = "Transcript Type",
                    breaks = c("pre", "mature"),
                    labels = c("pre-mRNA", "mature-mRNA")) +
  theme(
    axis.text.x = element_text(angle = 90,
                               vjust = 0.5,
                               hjust = 0.5)
  )
#ggsave("total_transcript_distribution.pdf")
```


## Heatmaps
```{r find_increasing}
tpm_means %>% 
  ungroup() %>% 
  split(., .$strain) -> per_strain_tpms

set_rowids <- function(df, colname = "gene_id"){
  rownames(df) <- df[[colname]]
  df[, 1] <- NULL
  df
}

map(per_strain_tpms, ~.x %>% 
          dplyr::select(-stage, -strain) %>% 
  spread(developmental_stage, mean_primary) %>% 
    as.data.frame() %>%
    set_rowids(.)) -> mats

#compute z-scores

map(mats, 
    ~t(scale(t(.x)))) -> zmats

plts <- map2(zmats,
     names(zmats),
     ~Heatmap(na.omit(.x), 
              name = "pre-mRNA proportion\n (Z-Score)",
                    show_row_names = F, 
                    show_row_dend = F,
              column_title = .y,
                ))

plts

all_mat <- do.call(cbind, mats)
all_zmat <- t(scale(t(all_mat)))

Heatmap(na.omit(all_zmat), name = "pre-mRNA proportion\n (Z-Score)",
        column_title = "All datasets",
                    show_row_names = F, 
                    show_row_dend = F) -> all_plt

all_plt
```


```{r}
tpm_summary %>% 
  dplyr::select(gene_id, developmental_stage, strain, mature, pre) %>% 
  gather("type", "total_tpm", mature, pre, 
         -gene_id, -developmental_stage, -strain) %>% 
  split(., .$type) -> tpm_split 

map(tpm_split, ~.x %>% 
  mutate(col_id = paste0(strain, "::", developmental_stage)) %>% 
  dplyr::select(-developmental_stage, -type, -strain) %>% 
  spread(col_id, total_tpm) %>% 
    as.data.frame() %>%
    set_rowids(.)) -> tpm_mats

map(tpm_mats, 
    ~cor(.x, use = "complete.obs", method = "spearman")) -> tpm_cors

map2(tpm_cors,
    c("Mature Transcripts", 
      "pre-mRNA Transcripts"),
    ~Heatmap(.x, 
             column_title = .y,
             name = "Spearman Correlation\nof TPM values"))
```


## Classify transcripts into maternal or zygotic

Next I'll try to classify transcripts into catagories based upon their abundance changes throughout embryogenesis. 

First need to identify transcripts that are differentially expressed between maternal and zygotic states. Let's try a two state comparison of 
pre MZT and post MZT, which based on the correlation matrix shown above, is strongly segregated between the two.

First generate salmon quant.sf files for pre-mRNAs or mature mRNAs independently for loading into `tximport`
```{r, split_salmon}

tx2gene_mapping <- dplyr::select(dat, 
                         transcript_id, 
                         gene_id) %>% 
  unique() %>% 
  as.data.frame()

files <- dir(file.path(data_dir, "salmon"),
            recursive = T,
            pattern = "*quant.sf",
            full.names = T)

sra_ids <- dirname(files) %>% 
  str_split(., "/", simplify = T) %>% 
  .[, 8]

keep <- sra_ids %in% mdata$Run
files <- files[keep]
sra_ids <- sra_ids[keep]

all_dat <- map(files, read_tsv)

all_pre <- map(all_dat, 
                 ~dplyr::filter(.x,
                                str_detect(Name, "^pre_")))

all_mat <- map(all_dat, 
               ~dplyr::filter(.x,
                              !str_detect(Name, "^pre_")))

dir.create("salmon_modified", recursive = T)

walk2(all_pre,
      sra_ids,
      ~write_tsv(.x, file.path("salmon_modified", 
                               paste0(.y, ".premRNA"))))
walk2(all_mat,
      sra_ids,
      ~write_tsv(.x, file.path("salmon_modified", 
                               paste0(.y, ".maturemRNA"))))
```


```{r}
files <- dir("salmon_modified", full.names = T)

mature <- str_subset(files, "maturemRNA$")
pre <- str_subset(files, "premRNA$")

matures <- tximport(mature, 
         type = "salmon",
         tx2gene = tx2gene_mapping)

pres <- tximport(pre, 
         type = "salmon",
         tx2gene = tx2gene_mapping)

# make metadata sample ordered by columns in count matrix
pdata <- inner_join(data_frame(Run = sra_ids),
           mdata, by = "Run")

pdata <- mutate(pdata, 
                mzt = ifelse(str_detect(developmental_stage,
                                        "^[2345]-[3456] hr embryo"),
                             "zygotic",
                             "maternal"))
```


```{r deseq2}

dds <- DESeqDataSetFromTximport(matures, pdata, ~mzt)
dds_mature <- DESeq(dds)
res_mature <- results(dds_mature)
res_mature_tidy <- results(dds_mature, tidy = TRUE)

dds <- DESeqDataSetFromTximport(pres, pdata, ~mzt)
dds_pre <- DESeq(dds)
res_pre <- results(dds_pre)
res_pre_tidy <- results(dds_pre, tidy = TRUE)
```


```{r}
pre_plot_dat <- res_pre_tidy %>% 
  as_tibble() %>% 
  mutate(sig = ifelse(padj < 0.05 & log2FoldChange > 0, "Up", 
                      ifelse(padj < 0.05 & log2FoldChange < 0, "Down", "Not Sig")))
n_sig_up <- nrow(dplyr::filter(pre_plot_dat, sig == "Up")) %>% 
  formatC(big.mark = ",")
n_sig_down <- nrow(dplyr::filter(pre_plot_dat, sig == "Down"))  %>% 
  formatC(big.mark = ",")
n_notsig <- nrow(dplyr::filter(pre_plot_dat, sig == "Not Sig"))  %>% 
  formatC(big.mark = ",")

p <- ggplot(pre_plot_dat, 
       aes(baseMean, log2FoldChange)) +
  geom_point(aes(colour = sig), size = 0.1) +
  scale_colour_viridis(discrete = TRUE,
                       name = "",
                       labels = c(paste0("Sig down (n = ", n_sig_down, ")"),
                                  paste0("Not Sig (n= ", n_notsig, ")"),
                                  paste0("Sig up (n = ", n_sig_up, ")"))) +
  scale_x_log10() + 
  labs(x = expression(paste("log"[10], " Average Expression")),
       y = expression(paste("log"[2], " ", frac("Zygotic", "Maternal")))) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "top")
  
p
save_plot("MA_zm_deseq_premRNA.pdf", p, base_width = 6)
```

```{r heatmap_zygotic, fig.width=8}
res_pre_sig <- res_pre_tidy %>% 
  as_tibble() %>% 
  dplyr::filter(!is.na(padj), padj < 0.05)

dds_pre <- rlog(dds_pre)

# add in colnames
cols <- pdata %>% 
  mutate(cnames = str_c(developmental_stage, strain , sep = "::")) %>% 
  pull(cnames)

rlog_counts <- assay(dds_pre)
colnames(rlog_counts) <- cols

scale_pre_mat <-t(scale(t(rlog_counts)))

sig_pre_mat <- scale_pre_mat[rownames(scale_pre_mat) %in% res_pre_sig$row, ]

Heatmap(sig_pre_mat, 
        name = "pre-mRNA\nabundance\nZ-score",
        show_row_names = F,
        show_row_dend = F)

pdf("premRNA_abundance.pdf")
Heatmap(sig_pre_mat, 
        name = "pre-mRNA\nabundance\nZ-score",
        show_row_names = F,
        show_row_dend = F)
dev.off()

dds_mature <- rlog(dds_mature)

rlog_counts <- assay(dds_mature)
colnames(rlog_counts) <- cols

scale_mature_mat <- t(scale(t(rlog_counts)))

scale_mature_mat <- scale_mature_mat[rownames(scale_mature_mat) %in% res_pre_sig$row, ]

scale_mature_mat <- na.omit(scale_mature_mat)

Heatmap(scale_mature_mat, 
        name = "mature-mRNA abundance",
        show_row_names = F,
        show_row_dend = F)

pdf("mature_mRNA_abundance.pdf")
Heatmap(scale_mature_mat, 
        name = "mature-mRNA\nabundance\nZ-score",
        show_row_names = F,
        show_row_dend = F)
dev.off()
```

```{r plot_side_by_side}
.cols <- str_detect(colnames(sig_pre_mat), "embryo")
sig_pre_emb <- sig_pre_mat[, .cols]
sig_mature_emb <- scale_mature_mat[, .cols]

genes_to_plot <- intersect(rownames(sig_pre_emb),
                           rownames(sig_mature_emb))

by_strain_pre <- map(unique(dat$strain), 
                 function(x){
                   sig_pre_emb[genes_to_plot, str_detect(colnames(sig_pre_emb), x)]
                 })

by_strain_mat <- map(unique(dat$strain), 
                 function(x){
                   sig_mature_emb[genes_to_plot, str_detect(colnames(sig_mature_emb), x)]
                 })

map2(by_strain_pre,
     by_strain_mat,
     function(x, y){
       ht1 <- Heatmap(x, 
         name = "pre-mRNA abundance",
         show_row_names = F,
         show_row_dend = F)

       ht2 <- Heatmap(y, 
         name = "mature-mRNA abundance",
         show_row_names = F,
         show_row_dend = F)

       print(ht1 + ht2)
     })

```

```{r calc_time_to_point}

  
## there is probably an analytic way to do this...
find_tpt <- function(x, timepoints, expr_cutoff) {
  pfun <- pracma::pchipfun(timepoints, x) 
  function_to_optimize <- function(x, lim) {abs(lim - pfun(x))}
  opt <- optimize(function_to_optimize, 
                  lower = min(timepoints), 
                  upper = max(timepoints), 
                  lim = expr_cutoff)
  opt$minimum
}

map(by_strain_pre, 
    function(x){
      
    interpolated_times <- apply(x, 1, find_tpt, timepoints = tpts[1:ncol(x)], expr_cutoff = 1)
    ordered_by_time <- sort(interpolated_times)
    
    Heatmap(x, 
             name = "pre-mRNA abundance",
             show_row_names = F,
             show_row_dend = F,
            cluster_rows = F,
            row_order = names(ordered_by_time))
})

map(by_strain_mat, 
    function(x){
      
    interpolated_times <- apply(x, 1, find_tpt, timepoints = tpts[1:ncol(x)], expr_cutoff = 1)
    ordered_by_time <- sort(interpolated_times)
    
    Heatmap(x, 
             name = "pre-mRNA abundance",
             show_row_names = F,
             show_row_dend = F,
            cluster_rows = F,
            row_order = names(ordered_by_time))
})
```

## Eisen classification
  Compare our classifications to Eisen's classifcations based on SNP inheritance patterns. 
  
```{r eisen_dat}
library("org.Dm.eg.db")
edata <- read_tsv("https://ndownloader.figshare.com/files/400050")

res_pre_tidy
res_pre_tidy$symbol <- mapIds(org.Dm.eg.db, 
                            keys=res_pre_tidy$row, 
                            column="SYMBOL", 
                            keytype="ENSEMBL",
                            multiVals="first")

res_pre_tidy$entrez <- mapIds(org.Dm.eg.db, 
                            keys=res_pre_tidy$row, 
                            column="ENTREZID", 
                            keytype="ENSEMBL",
                            multiVals="first")

res_pre_tidy$name =   mapIds(org.Dm.eg.db,
                           keys=res_pre_tidy$row, 
                           column="GENENAME",
                           keytype="ENSEMBL",
                           multiVals="first")
    

res_pre_sig <- res_pre_tidy %>% 
  as_tibble() %>% 
  dplyr::filter(!is.na(padj), padj < 0.05)


res_pre_sig <- edata %>% 
  dplyr::select(NAME, CLASS) %>% 
  left_join(res_pre_sig, ., by = c("symbol" = "NAME"))

res_pre_sig %>% dplyr::count(CLASS)
```

## Calc mean gene level TPMs to classify striclty maternal or zygotic. 

```{r mean_gene_tpms}
colnames(matures$abundance) <- sra_ids 
colnames(pres$abundance) <- sra_ids

# mean mature-mRNA TPMs
gene_tpm_mature <- matures$abundance %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  as_tibble() %>% 
  gather(Run, expr, -gene_id) %>% 
  left_join(pdata, by = "Run") %>% 
  group_by(developmental_stage, gene_id, strain, mzt) %>% 
  mutate(mean_tpm = mean(expr)) %>% 
  ungroup() %>% 
  dplyr::select(developmental_stage, gene_id, strain, mzt, mean_tpm) %>% 
  unique() 

# mean pre-mRNA TPMs
gene_tpm_pre <- pres$abundance %>% 
  as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  as_tibble() %>% 
  gather(Run, expr, -gene_id) %>% 
  left_join(pdata, by = "Run") %>% 
  group_by(developmental_stage, gene_id, strain, mzt) %>% 
  mutate(mean_tpm = mean(expr)) %>% 
  ungroup() %>% 
  dplyr::select(developmental_stage, gene_id, strain, mzt, mean_tpm) %>% 
  unique() 

mzt_tpms <- left_join(gene_tpm_mature,
                      gene_tpm_pre,
                      by = c("gene_id"))

#calc log2 ratios of zygotic / maternal

mzt_tpms <- mutate(mzt_tpms, 
                   zm_mature_ratio = log2(mzt_mature_zygotic / mzt_mature_maternal),
                   zm_pre_ratio = log2(mzt_pre_zygotic / mzt_pre_maternal))
```

```{r zm_ratio_hists}
plot_dat <- mzt_tpms %>% 
  dplyr::select(gene_id, zm_mature_ratio, zm_pre_ratio) %>% 
  dplyr::rename(mature = zm_mature_ratio,
                `pre-mRNA` = zm_pre_ratio) %>% 
  gather(stage, zm_ratio, -gene_id) 

p <- ggplot(plot_dat, aes(zm_ratio)) +
  geom_density(aes(fill = stage), alpha = 0.75) +
  scale_fill_viridis(discrete = TRUE,
                     name = "") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  labs(x = expression(paste("Log"[2], " ", 
                            frac("Zygotic", "Maternal"), 
                            " TPM"))) +
  theme_cowplot() +
  theme(legend.position = "top")

p
save_plot("zm_ratio.pdf", p, base_height = 4)
```

## Strictly Zygotic transcripts

```{r tpm_cutoff}
min_tpm <- 0.25
```
  
  Transcripts that are only expressed in zygotic samples, are by definition newly transcribed. These will be defined as those transcripts with < `r min_tpm` TPM in maternal stages, and higher than `r min_tpm` in zygotic stages. 
  
```{r exprsed, eval = F}
res_pre_tidy_summary <- dplyr::select(res_pre_tidy,
                               row:padj)

deseq_results_summary <- left_join(res_pre_tidy_summary,
                                  res_mature_tidy,
                                  by = "row",
                                  suffix = c("_pre", "_mature"))

mzt_tpms <- left_join(mzt_tpms,
                      deseq_results_summary,
                      by = c("gene_id" = "row"))

mzt_tpms <- mzt_tpms %>% 
  mutate(classification = ifelse(mzt_mature_maternal < min_tpm & mzt_mature_zygotic < min_tpm, 
                                 "lowly expressed",
                                 ifelse(mzt_mature_maternal > min_tpm,
                                 "maternal",
                                 ifelse(mzt_mature_zygotic > min_tpm,
                                        "zygotic",
                                        "mixed"))))
```

  First genes that are not expressed sufficiently high in either stage are dropped, resulting in `r nrow(mzt_tpms)` expressed genes.
  
```{r zygotic_txs}

zygotic <- mzt_tpms %>% 
    dplyr::filter(mzt_mature_maternal <= min_tpm, 
                mzt_mature_zygotic > min_tpm)
                
plot_dat <- zygotic %>% 
  dplyr::select(gene_id, zm_mature_ratio, zm_pre_ratio) %>% 
  dplyr::rename(mature = zm_mature_ratio,
                `pre-mRNA` = zm_pre_ratio) %>% 
  gather(stage, zm_ratio, -gene_id) 

p <- ggplot(plot_dat, aes(zm_ratio)) +
  geom_density(aes(fill = stage), alpha = 0.75) +
  scale_fill_viridis(discrete = TRUE,
                     name = "") +
  labs(x = expression(paste("Log"[2], " ", 
                            frac("Zygotic", "Maternal"), 
                            " TPM"))) +
  theme_cowplot() +
  theme(legend.position = "top")

p


zygotic_mat <- all_zmat[rownames(all_zmat) %in% mzt_tpms$gene_id, ]

Heatmap(na.omit(zygotic_mat), name = "pre-mRNA proportion\n (Z-Score)",
        column_title = "All datasets",
                    show_row_names = F, 
                    show_row_dend = F) 

```


## Strictly maternal


## Maternal + Zygotic transcripts

  Transcripts expressed in the oocyte are maternal (> `r min_tpm` TPM), and if these transcripts increase in abundance in the zygote (either through `exonic` or `intronic` single increases), then they are maternal + zygotic. 
  
```{r mat_and_zy, eval = F}



```


## Check motifs in zygotic transcripts

```{r check_motifs}
fa <- "~/Projects/shared_dbases/genomes/drosophila/Drosophila_melanogaster.BDGP6.dna.toplevel.fa"
zyg_coords <- filter(gtf, 
       gene_id %in% zygotic$gene_id)

gnome <- read_tsv(str_c(fa, ".fai"), col_types = "ci---", col_names = c("chrom", "size"))

tss_proximal <- filter(zyg_coords,
                     type == "transcript") %>% 
  dplyr::select(chrom = seqnames,
                start, end, transcript_id, strand) %>% 
  unique() %>% 
  mutate(start = start - 1,
    end = ifelse(strand == "+",
                 start + 1,
                 end),
    start = ifelse(strand == "+",
                   start,
                   end - 1)) %>% 
  group_by(strand) %>% 
  bed_merge(transcript_id = values_unique(transcript_id)) %>% 
  bed_slop(genome = gnome, left = 1000, right = 100, strand = T)

all_tss_proximal <- filter(gtf,
                     type == "transcript") %>% 
  dplyr::select(chrom = seqnames,
                start, end, transcript_id, strand) %>% 
  unique() %>% 
  mutate(start = start - 1,
    end = ifelse(strand == "+",
                 start + 1,
                 end),
    start = ifelse(strand == "+",
                   start,
                   end - 1)) %>% 
  group_by(strand) %>% 
  bed_merge(transcript_id = values_unique(transcript_id)) %>% 
  bed_slop(genome = gnome, left = 1000, right = 100, strand = T)

zyg_coords_seqs <- kentr::get_sequences(tss_proximal, fa)
write_fasta(zyg_coords_seqs, "zygotic_tss.fa", header_col = "transcript_id")

gtf_seqs <- kentr::get_sequences(all_tss_proximal, fa)
write_fasta(gtf_seqs, "gtf.fa", header_col = "transcript_id")
```